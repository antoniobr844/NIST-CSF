@{
    ViewData["Title"] = "Editar Cen√°rio";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Configura√ß√µes da p√°gina
    var urlParams = Context.Request.Query;
    var cenarioId = urlParams["id"];
    var tipoCenario = urlParams["tipo"];
    var subcategoriaId = urlParams["subcategoriaId"];
}

@section Styles {
    <style>
        /* === VARI√ÅVEIS CSS === */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --success-color: #27ae60;
            --success-dark: #2ecc71;
            --info-color: #17a2b8;
            --info-dark: #138496;
            --secondary-color: #6c757d;
            --secondary-dark: #5a6268;
            --dark-color: #2c3e50;
            --light-color: #f8f9fa;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-radius: 8px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        /* === LAYOUT PRINCIPAL === */
        .edicao-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        .edicao-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }

        .edicao-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        .edicao-header h1 {
            margin: 0 0 10px 0;
            font-size: 1.8em;
            font-weight: 600;
        }

        .edicao-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            backdrop-filter: blur(10px);
        }

        .edicao-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin: 0 5px;
        }

        /* === ALERTAS E MENSAGENS === */
        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 20px 0;
            color: #0c5460;
            border-left: 4px solid var(--info-color);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--secondary-color);
            font-style: italic;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            margin: 20px 0;
            border-left: 4px solid var(--danger-color);
            animation: shake 0.5s ease;
        }

        /* === BOT√ïES === */
        .action-buttons {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), var(--success-dark));
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), var(--info-dark));
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }

        /* === FORMUL√ÅRIOS === */
        .scenario-comparison {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .scenario-section {
            background: var(--light-color);
            border-radius: var(--border-radius);
            padding: 20px;
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }

        .scenario-section:hover {
            box-shadow: var(--box-shadow);
        }

        /* === ESTILOS PARA EDI√á√ÉO === */
        .edicao-header-form {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .edicao-info-form {
            margin: 15px 0;
        }

        /* Estilos para garantir que os formul√°rios fiquem corretos */
        .subcategory-item {
            background: white;
            margin: 15px 0;
            padding: 25px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* === ANIMA√á√ïES === */
        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @@keyframes shine {
            0% {
                transform: rotate(45deg) translateX(-100%);
            }

            100% {
                transform: rotate(45deg) translateX(100%);
            }
        }

        @@keyframes dots {

            0%,
            20% {
                color: rgba(0, 0, 0, 0);
                text-shadow: .25em 0 0 rgba(0, 0, 0, 0), .5em 0 0 rgba(0, 0, 0, 0);
            }

            40% {
                color: var(--secondary-color);
                text-shadow: .25em 0 0 rgba(0, 0, 0, 0), .5em 0 0 rgba(0, 0, 0, 0);
            }

            60% {
                text-shadow: .25em 0 0 var(--secondary-color), .5em 0 0 rgba(0, 0, 0, 0);
            }

            80%,
            100% {
                text-shadow: .25em 0 0 var(--secondary-color), .5em 0 0 var(--secondary-color);
            }
        }

        @@keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* === RESPONSIVIDADE === */
        @@media (max-width: 768px) {
            .edicao-container {
                padding: 15px;
            }

            .edicao-header {
                padding: 20px;
            }

            .edicao-header h1 {
                font-size: 1.5em;
            }

            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                justify-content: center;
            }
        }

        @@media (max-width: 480px) {
            .edicao-header {
                padding: 15px;
            }

            .edicao-header h1 {
                font-size: 1.3em;
            }

            .edicao-info {
                padding: 10px;
                font-size: 0.9em;
            }
        }

        /* === ESTILOS PARA O MODO EDI√á√ÉO ESPEC√çFICO === */
        .edicao-destaque {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7) !important;
            border-left: 4px solid #f39c12 !important;
        }

        .campo-obrigatorio label::after {
            content: " *";
            color: var(--danger-color);
        }

        .status-edicao {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1000;
            animation: slideInRight 0.5s ease;
        }

        @@keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
}

<div class="edicao-container">
    <!-- Cabe√ßalho Informativo -->
    <div class="edicao-header">
        <h1>
            <i class="fas fa-edit"></i> Editar Cen√°rio
            <span class="edicao-badge">@tipoCenario</span>
        </h1>
        <div class="edicao-info">
            <div>
                <strong>ID do Registro:</strong> <span class="edicao-badge">@cenarioId</span>
            </div>
            <div>
                <strong>Subcategoria ID:</strong> <span class="edicao-badge">@subcategoriaId</span>
            </div>
            <div>
                <strong>Tipo:</strong> <span class="edicao-badge">@tipoCenario</span>
            </div>
        </div>
        <div class="alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Modo Edi√ß√£o:</strong> Todas as altera√ß√µes ser√£o registradas em log com data/hora e usu√°rio
            respons√°vel.
        </div>
    </div>

    <!-- √Årea de Informa√ß√µes Din√¢micas -->
    <div id="selectionInfo" class="loading">
        Carregando dados para edi√ß√£o...
    </div>

    <!-- Container do Formul√°rio ESPEC√çFICO PARA EDI√á√ÉO -->
    <div class="scenario-comparison">
        <div class="scenario-section">
            <!-- Container √∫nico para edi√ß√£o -->
            <div id="edicaoScenarioContainer" class="loading">
                Inicializando formul√°rio de edi√ß√£o...
            </div>
        </div>
    </div>
    <!-- Bot√µes de A√ß√£o -->
    <div class="action-buttons">
        <button id="btnSalvar" class="btn btn-success" disabled>
            <i class="fas fa-save"></i> Salvar Altera√ß√µes
        </button>
        <button id="btnHistorico" class="btn btn-info">
            <i class="fas fa-history"></i> Ver Hist√≥rico
        </button>
        <button id="btnVoltar" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar para Relat√≥rios
        </button>
    </div>
</div>

@section Scripts {
    <!-- Carregar NISTCore primeiro -->
    <script src="~/js/core/nist-core.js" asp-append-version="true"></script>

    <script>
        // === CONFIGURA√á√ÉO E INICIALIZA√á√ÉO ===
        class EdicaoCenarioManager {
            constructor() {
                this.config = this.obterConfiguracao();
                this.app = null;
                this.inicializado = false;
            }

            obterConfiguracao() {
                const urlParams = new URLSearchParams(window.location.search);
                const config = {
                    modo: 'edicao',
                    modoEdicao: {
                        ativo: true,
                        cenarioId: parseInt(urlParams.get('id')),
                        tipoCenario: urlParams.get('tipo'),
                        subcategoriaId: parseInt(urlParams.get('subcategoriaId'))
                    }
                };

                // Validar configura√ß√£o
                if (!config.modoEdicao.cenarioId || !config.modoEdicao.tipoCenario || !config.modoEdicao.subcategoriaId) {
                    throw new Error('Par√¢metros de edi√ß√£o incompletos na URL.');
                }

                return config;
            }

            async inicializar() {
                try {
                    console.log('üöÄ Inicializando modo edi√ß√£o...', this.config.modoEdicao);

                    // Verificar se NISTCore est√° dispon√≠vel
                    if (typeof NISTCore === 'undefined') {
                        throw new Error('NISTCore n√£o foi carregado. Verifique o caminho do script.');
                    }

                    this.configurarEventos();
                    this.app = new NISTCore(this.config);

                    await this.carregarDados();
                    this.inicializado = true;

                    console.log('‚úÖ Modo edi√ß√£o inicializado com sucesso');
                    this.mostrarStatus('Sistema carregado com sucesso!', 'success');

                } catch (error) {
                    console.error('‚ùå Erro ao inicializar edi√ß√£o:', error);
                    this.mostrarErro(error);
                    throw error;
                }
            }

            configurarEventos() {
                // Eventos dos bot√µes
                const btnSalvar = document.getElementById('btnSalvar');
                const btnHistorico = document.getElementById('btnHistorico');
                const btnVoltar = document.getElementById('btnVoltar');

                if (btnSalvar) btnSalvar.addEventListener('click', () => this.salvar());
                if (btnHistorico) btnHistorico.addEventListener('click', () => this.verHistorico());
                if (btnVoltar) btnVoltar.addEventListener('click', () => this.voltar());

                // Eventos de teclado
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        this.salvar();
                    }
                });
            }

            async carregarDados() {
                try {
                    console.log('üì• Iniciando carregamento de dados para edi√ß√£o...');
                    console.log('Configura√ß√£o de edi√ß√£o:', this.config.modoEdicao);

                    // Garantir que o modo edi√ß√£o est√° ativo no NISTCore
                    this.app.config.modoEdicao = this.config.modoEdicao;
                    this.app.config.modo = 'edicao';

                    console.log('NISTCore config ap√≥s atualiza√ß√£o:', {
                        modo: this.app.config.modo,
                        modoEdicao: this.app.config.modoEdicao
                    });

                    const steps = [
                        { name: 'Carregando sele√ß√£o...', action: () => this.carregarSelecaoUnica() },
                        { name: 'Carregando prioridades...', action: () => this.app.carregarPrioridades() },
                        { name: 'Carregando n√≠veis...', action: () => this.app.carregarNiveis() },
                        { name: 'Carregando informa√ß√µes...', action: () => this.carregarInformacoesDetalhadasEdicao() },
                        { name: 'Carregando dados do cen√°rio...', action: () => this.app.carregarDadosCenarios() }
                    ];

                    for (const step of steps) {
                        console.log(`üîÑ ${step.name}`);
                        this.atualizarStatusCarregamento(step.name);
                        await step.action();
                    }

                    console.log('‚úÖ Todos os dados carregados, exibindo cen√°rio...');

                    // Chamar a exibi√ß√£o - deve detectar automaticamente o modo edi√ß√£o
                    this.app.exibirCenarios();

                    this.habilitarInterface();

                } catch (error) {
                    console.error('‚ùå Erro no carregamento de dados:', error);
                    throw error;
                }
            }

            async carregarSelecaoUnica() {
                const { subcategoriaId } = this.config.modoEdicao;

                this.app.selections = {
                    '1': {
                        '1': [subcategoriaId]
                    }
                };

                console.log('üéØ Sele√ß√£o √∫nica criada para edi√ß√£o:', this.app.selections);
                return true;
            }

            async carregarInformacoesDetalhadasEdicao() {
                try {
                    const { subcategoriaId } = this.config.modoEdicao;
                    console.log('üì• Carregando informa√ß√µes detalhadas para edi√ß√£o...');

                    // Carregar subcategoria espec√≠fica
                    if (!this.app.cache.subcategorias[subcategoriaId]) {
                        const subcategoria = await this.app.fetchAPI(`/api/Subcategorias/${subcategoriaId}`);
                        if (subcategoria) {
                            this.app.cache.subcategorias[subcategoriaId] = subcategoria;
                        }
                    }

                    // Carregar categorias relacionadas
                    const categorias = await this.app.fetchAPI('/api/Categorias');
                    if (categorias?.length) {
                        categorias.forEach(categoria => {
                            this.app.cache.categorias[categoria.id || categoria.ID] = categoria;
                        });
                    }

                    console.log('‚úÖ Informa√ß√µes detalhadas carregadas para edi√ß√£o');
                } catch (error) {
                    console.error('‚ùå Erro ao carregar informa√ß√µes para edi√ß√£o:', error);
                    throw error;
                }
            }

            atualizarStatusCarregamento(mensagem) {
                const element = document.getElementById('selectionInfo');
                if (element) {
                    element.innerHTML = `<div class="loading">${mensagem}</div>`;
                }
            }

            habilitarInterface() {
                const btnSalvar = document.getElementById('btnSalvar');
                if (btnSalvar) btnSalvar.disabled = false;

                const selectionInfo = document.getElementById('selectionInfo');
                if (selectionInfo) {
                    selectionInfo.innerHTML = `
                            <div class="alert-info">
                                <i class="fas fa-check-circle"></i>
                                <strong>Pronto para editar!</strong> Preencha os campos abaixo e clique em "Salvar Altera√ß√µes".
                            </div>
                        `;
                }
            }

            async salvar() {
                if (!this.inicializado) return;

                try {
                    await this.app.salvarAlteracoes();
                } catch (error) {
                    console.error('Erro ao salvar:', error);
                    this.mostrarStatus('Erro ao salvar altera√ß√µes!', 'error');
                }
            }

            verHistorico() {
                if (!this.inicializado) return;

                const { subcategoriaId, tipoCenario } = this.config.modoEdicao;
                this.visualizarHistorico(subcategoriaId, tipoCenario);
            }

            async visualizarHistorico(subcategoriaId, tipoCenario = 'ATUAL') {
                try {
                    const url = `/api/Cenarios/historico?subcategoriaId=${subcategoriaId}&tipo=${tipoCenario}`;

                    const response = await fetch(url);
                    const historico = await response.json();

                    if (historico?.length) {
                        this.exibirModalHistorico(historico);
                    } else {
                        alert('Nenhum hist√≥rico encontrado para esta subcategoria.');
                    }
                } catch (error) {
                    console.error('Erro ao carregar hist√≥rico:', error);
                    alert('Erro ao carregar hist√≥rico.');
                }
            }

            exibirModalHistorico(historico) {
                const modal = document.createElement('div');
                modal.className = 'modal-edicao';
                modal.innerHTML = `
                        <div class="modal-content">
                            <h3><i class="fas fa-history"></i> Hist√≥rico de Altera√ß√µes</h3>
                            <div class="historico-lista">
                                ${historico.map(item => `
                                    <div class="historico-item">
                                        <strong>${item.CAMPO_ALTERADO || 'Campo n√£o identificado'}</strong>
                                        <div class="historico-detalhes">
                                            <span class="valor-antigo"><strong>De:</strong> ${item.VALOR_ANTIGO || '<em>vazio</em>'}</span>
                                            <span class="valor-novo"><strong>Para:</strong> ${item.VALOR_NOVO || '<em>vazio</em>'}</span>
                                        </div>
                                        <small class="historico-meta">
                                            <i class="fas fa-user"></i> ${item.USUARIO || 'Sistema'} 
                                            <i class="fas fa-clock"></i> ${new Date(item.DATA_ALTERACAO).toLocaleString('pt-BR')}
                                        </small>
                                    </div>
                                `).join('') || '<p class="historico-vazio">Nenhum hist√≥rico encontrado</p>'}
                            </div>
                            <button class="btn btn-secondary btn-fechar">
                                <i class="fas fa-times"></i> Fechar
                            </button>
                        </div>
                    `;

                // Estilos do modal
                Object.assign(modal.style, {
                    position: 'fixed',
                    top: '0',
                    left: '0',
                    width: '100%',
                    height: '100%',
                    background: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    justifyContent: 'center',
                    alignItems: 'center',
                    zIndex: '1000'
                });

                // Estilos do conte√∫do do modal
                const modalContent = modal.querySelector('.modal-content');
                Object.assign(modalContent.style, {
                    background: 'white',
                    padding: '25px',
                    borderRadius: '8px',
                    maxWidth: '600px',
                    maxHeight: '80vh',
                    overflowY: 'auto',
                    boxShadow: '0 10px 30px rgba(0,0,0,0.3)',
                    width: '90%'
                });

                // Estilos dos itens do hist√≥rico
                const historicoItems = modal.querySelectorAll('.historico-item');
                historicoItems.forEach(item => {
                    Object.assign(item.style, {
                        borderLeft: '4px solid #3498db',
                        padding: '15px',
                        margin: '10px 0',
                        background: '#f8f9fa',
                        borderRadius: '6px'
                    });
                });

                modal.querySelector('.btn-fechar').onclick = () => modal.remove();
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

                document.body.appendChild(modal);
            }

            voltar() {
                if (confirm('Tem certeza que deseja voltar? As altera√ß√µes n√£o salvas ser√£o perdidas.')) {
                    window.location.href = '/Home/Relatorios';
                }
            }

            mostrarStatus(mensagem, tipo = 'info') {
                console.log(`[${tipo.toUpperCase()}] ${mensagem}`);
            }

            mostrarErro(error) {
                const errorHtml = `
                        <div class="error">
                            <h3><i class="fas fa-exclamation-triangle"></i> Erro ao carregar dados para edi√ß√£o</h3>
                            <p>${error.message}</p>
                            <p><small>Verifique se o registro ainda existe e se voc√™ tem permiss√£o para edit√°-lo.</small></p>
                            <div style="margin-top: 15px;">
                                <button onclick="location.reload()" class="btn btn-secondary">
                                    <i class="fas fa-redo"></i> Tentar Novamente
                                </button>
                                <button onclick="window.location.href = '/Home/Relatorios'" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Voltar para Relat√≥rios
                                </button>
                            </div>
                        </div>
                    `;

                document.getElementById('selectionInfo').innerHTML = errorHtml;
            }
        }

        // === INICIALIZA√á√ÉO DA P√ÅGINA ===
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const editor = new EdicaoCenarioManager();
                await editor.inicializar();

                // Expor globalmente para debug
                window.edicaoManager = editor;
                console.log('‚úÖ Editor de cen√°rio inicializado:', editor);

            } catch (error) {
                console.error('Falha cr√≠tica na inicializa√ß√£o:', error);

                // Fallback: tentar carregar scripts manualmente se NISTCore n√£o estiver dispon√≠vel
                if (error.message.includes('NISTCore')) {
                    console.warn('‚ö†Ô∏è Tentando carregar NISTCore manualmente...');

                    // Criar um script element para carregar o NISTCore
                    const script = document.createElement('script');
                    script.src = '/js/core/nist-core.js';
                    script.onload = () => {
                        console.log('‚úÖ NISTCore carregado manualmente. Recarregue a p√°gina.');
                        location.reload();
                    };
                    script.onerror = () => {
                        console.error('‚ùå Falha ao carregar NISTCore manualmente.');
                        document.getElementById('selectionInfo').innerHTML = `
                                <div class="error">
                                    <h3>Erro Cr√≠tico</h3>
                                    <p>N√£o foi poss√≠vel carregar o sistema NISTCore.</p>
                                    <p><strong>Arquivo n√£o encontrado:</strong> /js/core/nist-core.js</p>
                                    <button onclick="location.reload()" class="btn btn-secondary">
                                        <i class="fas fa-redo"></i> Tentar Novamente
                                    </button>
                                </div>
                            `;
                    };
                    document.head.appendChild(script);
                }
            }
        });

        // Debug tempor√°rio - verificar elementos
        console.log('üîç Debug - Elementos na p√°gina:');
        console.log('- edicaoScenarioContainer:', document.getElementById('edicaoScenarioContainer'));
        console.log('- selectionInfo:', document.getElementById('selectionInfo'));
    </script>
}