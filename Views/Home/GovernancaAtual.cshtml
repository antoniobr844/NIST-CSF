<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIST CSF - Alterações - Governança</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 600;
            color: #2c3e50;
        }

        .selection-info {
            background: #e8f4fc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #3498db;
        }

        .selection-info h2 {
            margin-bottom: 15px;
            color: #3498db;
        }

        .scenario-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .scenario-section {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .scenario-header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .scenario-content {
            padding: 20px;
        }

        .future-scenario .scenario-header {
            background: #7f8c8d;
        }

        .current-scenario .scenario-header {
            background: #27ae60;
        }

        .function-section {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .function-header {
            background: #3498db;
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .function-header h2 {
            margin: 0;
            font-size: 1.4em;
        }

        .function-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .function-content.expanded {
            max-height: 5000px;
        }

        .category-section {
            border-bottom: 1px solid #eee;
        }

        .category-header {
            background: #f8f9fa;
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2em;
        }

        .category-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .category-content.expanded {
            max-height: 5000px;
        }

        .subcategory-item {
            background: #ffffff;
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .subcategory-item:last-child {
            border-bottom: none;
        }

        .subcategory-item h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.1em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            resize: vertical;
        }

        .form-group textarea {
            min-height: 100px;
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-check-input {
            width: auto !important;
            transform: scale(1.2);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn-voltar {
            background: #95a5a6;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-voltar:hover {
            background: #7f8c8d;
        }

        .btn-salvar {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-salvar:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
        }

        .btn-avancar {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-avancar:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
        }

        .error-message {
            background: #ffecec;
            color: #e10;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e10;
            margin-bottom: 20px;
        }

        .success-message {
            background: #e8f5e9;
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
            margin-bottom: 20px;
        }

        .info-message {
            background: #e8f4fc;
            color: #3498db;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin-bottom: 20px;
        }

        .toggle-icon::after {
            content: "▼";
            font-size: 0.8em;
            transition: transform 0.3s;
        }

        .toggle-icon.expanded::after {
            transform: rotate(180deg);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .remove-btn {
            background: transparent;
            border: none;
            font-size: 1.2em;
            color: #e74c3c;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .remove-btn:hover {
            transform: scale(1.2);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .combo-container {
            margin-bottom: 20px;
        }

        .readonly-field {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .field-note {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>NIST CSF - Alterações - Governança</h1>

        <div class="selection-info" id="selectionInfo">
            <h2>Carregando seleção...</h2>
        </div>

        <div class="scenario-container">
            <!-- Cenário Futuro (somente leitura) -->
            <div class="scenario-section future-scenario">
                <div class="scenario-header">
                    CENÁRIO FUTURO (Dados do Banco - Somente Leitura)
                </div>
                <div class="scenario-content">
                    <div id="futureScenarioContainer">
                        <div class="loading">Carregando cenário futuro...</div>
                    </div>
                </div>
            </div>

            <!-- Cenário Atual (editável) -->
            <div class="scenario-section current-scenario">
                <div class="scenario-header">
                    CENÁRIO ATUAL (Editável)
                </div>
                <div class="scenario-content">
                    <div id="currentScenarioContainer">
                        <div class="loading">Carregando cenário atual...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="navigation">
            <button class="btn-voltar" onclick="voltarParaAnterior()">← Voltar para Seleção</button>
            <button class="btn-salvar" onclick="salvarAlteracoesAtual()">Salvar Alterações</button>
            <button class="btn-avancar" onclick="avancarParaProxima()">Avançar para Próxima Função</button>
        </div>
    </div>

    <script>
        const ordemFuncoes = ["governanca", "identificar", "proteger", "detectar", "responder", "recuperar"];
        const funcaoAtual = "governanca";

        // Mapeamento dos IDs numéricos para nomes das funções
        const mapeamentoFuncoes = {
            '1': 'governanca',
            '2': 'identificar',
            '3': 'proteger',
            '4': 'detectar',
            '5': 'responder',
            '6': 'recuperar'
        };

        // Dados das funções para exibição amigável
        const functionNames = {
            'governanca': 'Governança (GV)',
            'identificar': 'Identificar (ID)',
            'proteger': 'Proteger (PR)',
            'detectar': 'Detectar (DE)',
            'responder': 'Responder (RS)',
            'recuperar': 'Recuperar (RC)'
        };

        // Cache para dados
        let categoriasCache = {};
        let subcategoriasCache = {};
        let dadosAtuaisCache = {};
        let dadosFuturosCache = {};
        let prioridadesData = [];
        let niveisData = [];

        // Função auxiliar para fetch com tratamento de erro
        async function fetchAPI(url) {
            try {
                console.log(`Fetching: ${url}`);
                const response = await fetch(url);

                if (!response.ok) {
                    if (response.status === 404) {
                        console.warn(`Endpoint não encontrado (404): ${url}`);
                        return null;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error(`Erro na API ${url}:`, error.message);
                return null;
            }
        }

        // Carregar prioridades
        async function carregarPrioridades() {
            try {
                console.log('Carregando prioridades...');
                const data = await fetchAPI('/api/Dados/prioridades');

                if (data && Array.isArray(data)) {
                    prioridadesData = data;
                    console.log('Prioridades carregadas:', prioridadesData);
                } else {
                    console.warn('Não foi possível carregar prioridades, usando valores padrão');
                    prioridadesData = [
                        { id: 1, nivel: 'Alta' },
                        { id: 2, nivel: 'Média' },
                        { id: 3, nivel: 'Baixa' }
                    ];
                }

            } catch (error) {
                console.error('Erro ao carregar prioridades:', error);
                prioridadesData = [
                    { id: 1, nivel: 'Alta' },
                    { id: 2, nivel: 'Média' },
                    { id: 3, nivel: 'Baixa' }
                ];
            }
        }

        // Carregar níveis
        async function carregarNiveis() {
            try {
                console.log('Carregando níveis...');
                const data = await fetchAPI('/api/Dados/status');

                if (data && Array.isArray(data)) {
                    niveisData = data;
                    console.log('Níveis carregados:', niveisData);
                } else {
                    console.warn('Não foi possível carregar níveis, usando valores padrão');
                    niveisData = [
                        { id: 1, nivel: 'Nível 1' },
                        { id: 2, nivel: 'Nível 2' },
                        { id: 3, nivel: 'Nível 3' },
                        { id: 4, nivel: 'Nível 4' },
                        { id: 5, nivel: 'Nível 5' }
                    ];
                }

            } catch (error) {
                console.error('Erro ao carregar níveis:', error);
                niveisData = [
                    { id: 1, nivel: 'Nível 1' },
                    { id: 2, nivel: 'Nível 2' },
                    { id: 3, nivel: 'Nível 3' },
                    { id: 4, nivel: 'Nível 4' },
                    { id: 5, nivel: 'Nível 5' }
                ];
            }
        }

        // Função segura para atualizar elementos
        function safeUpdateElement(elementId, content) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = content;
            } else {
                console.warn(`Elemento ${elementId} não encontrado para atualização`);
            }
        }

        // Carregar dados iniciais
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                console.log('=== INICIANDO CARREGAMENTO ===');

                // Carregar catálogos primeiro
                await carregarPrioridades();
                await carregarNiveis();

                // Carregar seleções do localStorage
                let selectedSubcategories = {};
                try {
                    const storedSelections = localStorage.getItem('nistSelections');
                    if (storedSelections) {
                        selectedSubcategories = JSON.parse(storedSelections);
                        console.log('Seleções carregadas:', selectedSubcategories);
                    }
                } catch (error) {
                    console.error('Erro ao carregar localStorage:', error);
                    safeUpdateElement('selectionInfo', `
                    <div class="error-message">
                        <h2>Erro ao carregar seleções</h2>
                        <p>${error.message}</p>
                    </div>
                `);
                    return;
                }

                // Verificar se há dados válidos
                if (Object.keys(selectedSubcategories).length === 0) {
                    safeUpdateElement('selectionInfo', `
                    <div class="error-message">
                        <h2>Nenhuma seleção encontrada</h2>
                        <p>Volte à página anterior para selecionar subcategorias.</p>
                    </div>
                `);
                    return;
                }

                // Carregar informações detalhadas
                await carregarInformacoesDetalhadas(selectedSubcategories);

                // Carregar dados do banco - AGORA CARREGA AUTOMATICAMENTE DO FUTURO PARA O ATUAL
                await carregarDadosFuturos(selectedSubcategories);
                await preencherAtualComDadosFuturo(selectedSubcategories);
                await carregarDadosAtuaisExistentes(selectedSubcategories);

                // Exibir os cenários
                exibirCenarios(selectedSubcategories);

                console.log('=== CARREGAMENTO CONCLUÍDO ===');

            } catch (error) {
                console.error('Erro crítico:', error);
                safeUpdateElement('selectionInfo', `
                <div class="error-message">
                    <h2>Erro ao carregar a página</h2>
                    <p>${error.message}</p>
                </div>
            `);
            }
        });

        // Funções auxiliares
        function getFunctionNameById(funcId) {
            if (mapeamentoFuncoes[funcId]) {
                return mapeamentoFuncoes[funcId];
            }
            const funcIdLower = funcId.toString().toLowerCase();
            if (funcIdLower.includes('gv') || funcIdLower.includes('govern') || funcIdLower === '1') return 'governanca';
            if (funcIdLower.includes('id') || funcIdLower.includes('identif') || funcIdLower === '2') return 'identificar';
            if (funcIdLower.includes('pr') || funcIdLower.includes('proteg') || funcIdLower === '3') return 'proteger';
            if (funcIdLower.includes('de') || funcIdLower.includes('detect') || funcIdLower === '4') return 'detectar';
            if (funcIdLower.includes('rs') || funcIdLower.includes('respond') || funcIdLower === '5') return 'responder';
            if (funcIdLower.includes('rc') || funcIdLower.includes('recuper') || funcIdLower === '6') return 'recuperar';
            return funcId;
        }

        // Carregar informações detalhadas das categorias e subcategorias
        async function carregarInformacoesDetalhadas(selectedSubcategories) {
            try {
                for (const funcId in selectedSubcategories) {
                    const functionName = getFunctionNameById(funcId);

                    // Carregar apenas para governança
                    if (functionName !== 'governanca') continue;

                    // Buscar categorias da função
                    try {
                        const categorias = await fetchAPI(`/api/Categorias?funcaoId=${funcId}`);
                        if (categorias && Array.isArray(categorias)) {
                            categorias.forEach(categoria => {
                                categoriasCache[categoria.id || categoria.ID] = categoria;
                            });
                        }
                    } catch (error) {
                        console.error('Erro ao carregar categorias:', error);
                    }

                    // Carregar informações das subcategorias
                    for (const categoryId in selectedSubcategories[funcId]) {
                        for (const subcategoryId of selectedSubcategories[funcId][categoryId]) {
                            if (!subcategoriasCache[subcategoryId]) {
                                try {
                                    const subcategoria = await fetchAPI(`/api/Subcategorias/${subcategoryId}`);
                                    if (subcategoria) {
                                        subcategoriasCache[subcategoryId] = subcategoria;
                                    } else {
                                        subcategoriasCache[subcategoryId] = {
                                            id: subcategoryId,
                                            codigo: `SC-${subcategoryId}`,
                                            descricao: 'Subcategoria não encontrada'
                                        };
                                    }
                                } catch (error) {
                                    console.error(`Erro ao carregar subcategoria ${subcategoryId}:`, error);
                                    subcategoriasCache[subcategoryId] = {
                                        id: subcategoryId,
                                        codigo: `SC-${subcategoryId}`,
                                        descricao: 'Erro ao carregar'
                                    };
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar informações detalhadas:', error);
            }
        }

        // Carregar dados futuros do banco - VERSÃO CORRIGIDA
async function carregarDadosFuturos() {
    const selections = JSON.parse(localStorage.getItem('nistSelections') || '{}');
    const promises = [];

    for (const funcId in selections) {
        const functionName = getFunctionNameById(funcId);
        if (functionName !== funcaoAtual) continue;

        for (const categoryId in selections[funcId]) {
            for (const subcategoryId of selections[funcId][categoryId]) {
                const promise = fetch(`/api/CenarioFuturo/ultimo?subcategoriaId=${subcategoryId}`)
                    .then(res => res.ok ? res.json() : null)
                    .then(data => {
                        if (data) dadosFuturosCache[subcategoryId] = data;
                    })
                    .catch(err => console.error(`Erro ao carregar cenário futuro ${subcategoryId}:`, err));

                promises.push(promise);
            }
        }
    }

    // Aguarda todas as requisições finalizarem
    await Promise.all(promises);

    console.log('✅ Todos os dados futuros carregados:', dadosFuturosCache);
    exibirCenarios(selections); // Agora sim, com o cache completo
}


// Função para debug - mostrar informações dos dados carregados
function mostrarDebugDadosFuturos() {
    console.log('=== DEBUG DADOS FUTUROS ===');
    let comDados = 0;
    let semDados = 0;
    
    for (const subcategoryId in dadosFuturosCache) {
        const dados = dadosFuturosCache[subcategoryId];
        const status = dados._semDados ? 'SEM DADOS' : 
                      (dados.prioridadeAlvo || dados.nivelAlvo) ? 'COM DADOS' : 'DADOS VAZIOS';
        
        console.log(`Subcategoria ${subcategoryId}: ${status}`, {
            prioridade: dados.prioridadeAlvo,
            nivel: dados.nivelAlvo,
            politicas: dados.politicasAlvo ? 'SIM' : 'NÃO',
            praticas: dados.praticasAlvo ? 'SIM' : 'NÃO',
            debug: dados._debug || 'N/A'
        });
        
        if (dados.prioridadeAlvo || dados.nivelAlvo) {
            comDados++;
        } else {
            semDados++;
        }
    }
    console.log(`=== RESUMO: ${comDados} com dados, ${semDados} sem dados ===`);
}
        // Função para debug - mostrar informações dos dados carregados
        function mostrarDebugDadosFuturos() {
            console.log('=== DEBUG DADOS FUTUROS ===');
            for (const subcategoryId in dadosFuturosCache) {
                const dados = dadosFuturosCache[subcategoryId];
                console.log(`Subcategoria ${subcategoryId}:`, {
                    prioridade: dados.prioridadeAlvo,
                    nivel: dados.nivelAlvo,
                    totalRegistros: dados._totalRegistros,
                    idRegistro: dados._idRegistroAtual,
                    temPoliticas: !!dados.politicasAlvo,
                    temPraticas: !!dados.praticasAlvo
                });
            }
            console.log('=== FIM DEBUG ===');
        }

        // NOVA FUNÇÃO: Preencher automaticamente o Cenário Atual com dados do Futuro
        async function preencherAtualComDadosFuturo(selectedSubcategories) {
            try {
                console.log('Preenchendo Cenário Atual com dados do Futuro...');

                const dadosParaSalvar = [];
                let subcategoriasProcessadas = 0;

                for (const funcId in selectedSubcategories) {
                    const functionName = getFunctionNameById(funcId);
                    if (functionName !== 'governanca') continue;

                    for (const categoryId in selectedSubcategories[funcId]) {
                        for (const subcategoryId of selectedSubcategories[funcId][categoryId]) {
                            const dadosFuturo = dadosFuturosCache[subcategoryId];

                            if (dadosFuturo && (dadosFuturo.prioridadeAlvo || dadosFuturo.nivelAlvo)) {
                                // Verificar se já existe no atual antes de criar
                                const dadosAtuaisExistentes = await verificarDadosAtuaisExistentes(subcategoryId);

                                if (!dadosAtuaisExistentes) {
                                    dadosParaSalvar.push({
                                        subcategoriaId: parseInt(subcategoryId),
                                        prioridade: dadosFuturo.prioridadeAlvo,
                                        status: dadosFuturo.nivelAlvo,
                                        politicasPro: dadosFuturo.politicasAlvo || '',
                                        praticasInternas: dadosFuturo.praticasAlvo || '',
                                        funcoesResp: dadosFuturo.funcoesAlvo || '',
                                        referenciasInfo: dadosFuturo.referenciasAlvo || '',
                                        artefatosEvi: dadosFuturo.artefatosAlvo || ''
                                    });
                                    subcategoriasProcessadas++;
                                }
                            }
                        }
                    }
                }

                if (dadosParaSalvar.length > 0) {
                    console.log(`Salvando ${dadosParaSalvar.length} subcategorias no Cenário Atual`);
                    await salvarDadosNoAtual(dadosParaSalvar);
                }

                console.log(`Processadas ${subcategoriasProcessadas} subcategorias do Futuro para o Atual`);

            } catch (error) {
                console.error('Erro ao preencher atual com dados futuro:', error);
            }
        }

        // Verificar se já existem dados no Cenário Atual
        async function verificarDadosAtuaisExistentes(subcategoryId) {
            try {
                const apiMap = {
                    'governanca': 'GovernancaAtual',
                    'identificar': 'IdentificarAtual',
                    'proteger': 'ProtegerAtual',
                    'detectar': 'DetectarAtual',
                    'responder': 'ResponderAtual',
                    'recuperar': 'RecuperarAtual'
                };

                const apiName = apiMap[funcaoAtual] || 'CenarioAtual';
                const dadosAtuais = await fetchAPI(`/api/${apiName}?subcategoriaId=${subcategoryId}`);

                return dadosAtuais && Array.isArray(dadosAtuais) && dadosAtuais.length > 0;
            } catch (error) {
                console.error(`Erro ao verificar dados atuais para ${subcategoryId}:`, error);
                return false;
            }
        }

        // Carregar dados atuais existentes
        async function carregarDadosAtuaisExistentes(selectedSubcategories) {
            try {
                console.log('Carregando dados existentes do Cenário Atual...');

                for (const funcId in selectedSubcategories) {
                    const functionName = getFunctionNameById(funcId);
                    if (functionName !== 'governanca') continue;

                    for (const categoryId in selectedSubcategories[funcId]) {
                        for (const subcategoryId of selectedSubcategories[funcId][categoryId]) {
                            try {
                                const apiMap = {
                                    'governanca': 'GovernancaAtual',
                                    'identificar': 'IdentificarAtual',
                                    'proteger': 'ProtegerAtual',
                                    'detectar': 'DetectarAtual',
                                    'responder': 'ResponderAtual',
                                    'recuperar': 'RecuperarAtual'
                                };

                                const apiName = apiMap[funcaoAtual] || 'CenarioAtual';
                                const dadosAtuais = await fetchAPI(`/api/${apiName}?subcategoriaId=${subcategoryId}`);

                                if (dadosAtuais && Array.isArray(dadosAtuais) && dadosAtuais.length > 0) {
                                    dadosAtuaisCache[subcategoryId] = {
                                        prioridade: dadosAtuais[0].prioridade,
                                        status: dadosAtuais[0].status,
                                        politicasPro: dadosAtuais[0].politicasPro || '',
                                        praticasInternas: dadosAtuais[0].praticasInternas || '',
                                        funcoesResp: dadosAtuais[0].funcoesResp || '',
                                        referenciasInfo: dadosAtuais[0].referenciasInfo || '',
                                        artefatosEvi: dadosAtuais[0].artefatosEvi || ''
                                    };
                                    console.log(`Dados atuais carregados para ${subcategoryId}:`, dadosAtuaisCache[subcategoryId]);
                                } else {
                                    // Se não existir dados no atual, usar dados do futuro
                                    const dadosFuturo = dadosFuturosCache[subcategoryId];
                                    dadosAtuaisCache[subcategoryId] = {
                                        prioridade: dadosFuturo?.prioridadeAlvo || '',
                                        status: dadosFuturo?.nivelAlvo || '',
                                        politicasPro: dadosFuturo?.politicasAlvo || '',
                                        praticasInternas: dadosFuturo?.praticasAlvo || '',
                                        funcoesResp: dadosFuturo?.funcoesAlvo || '',
                                        referenciasInfo: dadosFuturo?.referenciasAlvo || '',
                                        artefatosEvi: dadosFuturo?.artefatosAlvo || ''
                                    };
                                }
                            } catch (error) {
                                console.error(`Erro ao carregar dados atuais para ${subcategoryId}:`, error);
                                // Em caso de erro, usar dados do futuro
                                const dadosFuturo = dadosFuturosCache[subcategoryId];
                                dadosAtuaisCache[subcategoryId] = {
                                    prioridade: dadosFuturo?.prioridadeAlvo || '',
                                    status: dadosFuturo?.nivelAlvo || '',
                                    politicasPro: dadosFuturo?.politicasAlvo || '',
                                    praticasInternas: dadosFuturo?.praticasAlvo || '',
                                    funcoesResp: dadosFuturo?.funcoesAlvo || '',
                                    referenciasInfo: dadosFuturo?.referenciasAlvo || '',
                                    artefatosEvi: dadosFuturo?.artefatosAlvo || ''
                                };
                            }
                        }
                    }
                }
                console.log('Dados atuais carregados:', dadosAtuaisCache);
            } catch (error) {
                console.error('Erro ao carregar dados atuais:', error);
            }
        }

        // Função para salvar dados no Cenário Atual
        async function salvarDadosNoAtual(dados) {
            try {
                const apiMap = {
                    'governanca': 'GovernancaAtual',
                    'identificar': 'IdentificarAtual',
                    'proteger': 'ProtegerAtual',
                    'detectar': 'DetectarAtual',
                    'responder': 'ResponderAtual',
                    'recuperar': 'RecuperarAtual'
                };

                const apiName = apiMap[funcaoAtual] || 'CenarioAtual';

                const response = await fetch(`/api/${apiName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status} ao salvar dados`);
                }

                return await response.json();
            } catch (error) {
                console.error('Erro ao salvar dados no atual:', error);
                throw error;
            }
        }

        function obterNomeCategoria(categoryId) {
            const categoria = categoriasCache[categoryId];
            if (categoria) {
                return `${categoria.codigo || categoria.CODIGO || ''} - ${categoria.nome || categoria.NOME || ''}`;
            }
            return `Categoria ${categoryId}`;
        }

        function obterNomeSubcategoria(subcategoryId) {
            const subcategoria = subcategoriasCache[subcategoryId];
            if (subcategoria) {
                const codigoCompleto = subcategoria.codigo || subcategoria.CODIGO || `SC-${subcategoryId}`;
                const descricao = subcategoria.subcategoria || subcategoria.SUBCATEGORIA || subcategoria.descricao || subcategoria.DESCRICAO || '';
                return `${codigoCompleto} - ${descricao}`;
            }
            return `Subcategoria ${subcategoryId}`;
        }

        // Exibir ambos os cenários
        function exibirCenarios(selectedSubcategories) {
            const currentContainer = document.getElementById('currentScenarioContainer');
            const futureContainer = document.getElementById('futureScenarioContainer');
            const selectionInfo = document.getElementById('selectionInfo');

            if (!currentContainer || !futureContainer) {
                console.error('Containers não encontrados');
                return;
            }

            let totalSubcategories = 0;

            // Limpar containers
            currentContainer.innerHTML = '';
            futureContainer.innerHTML = '';

            // Para cada função e categoria, criar os formulários
            for (const funcId in selectedSubcategories) {
                const functionName = getFunctionNameById(funcId);

                // Mostrar apenas governança
                if (functionName !== 'governanca') continue;

                // Criar estrutura para cenário FUTURO (somente leitura)
                const futureFunctionDiv = criarEstruturaFuncao(functionName);
                const futureFunctionContent = futureFunctionDiv.querySelector('.function-content');

                // Criar estrutura para cenário ATUAL (editável)
                const currentFunctionDiv = criarEstruturaFuncao(functionName);
                const currentFunctionContent = currentFunctionDiv.querySelector('.function-content');

                let hasCategories = false;

                for (const categoryId in selectedSubcategories[funcId]) {
                    if (selectedSubcategories[funcId][categoryId].length > 0) {
                        hasCategories = true;

                        // Criar categoria para cenário FUTURO (somente leitura)
                        const futureCategoryDiv = criarEstruturaCategoria(categoryId);
                        const futureCategoryContent = futureCategoryDiv.querySelector('.category-content');

                        // Criar categoria para cenário ATUAL (editável)
                        const currentCategoryDiv = criarEstruturaCategoria(categoryId);
                        const currentCategoryContent = currentCategoryDiv.querySelector('.category-content');

                        // Adicionar subcategorias
                        selectedSubcategories[funcId][categoryId].forEach(subcategoryId => {
                            // Adicionar ao cenário FUTURO (somente leitura)
                            const futureSubcategoryDiv = criarFormularioFuturo(subcategoryId, totalSubcategories);
                            futureCategoryContent.appendChild(futureSubcategoryDiv);

                            // Adicionar ao cenário ATUAL (editável)
                            const currentSubcategoryDiv = criarFormularioAtual(subcategoryId, totalSubcategories);
                            currentCategoryContent.appendChild(currentSubcategoryDiv);

                            totalSubcategories++;
                        });

                        futureFunctionContent.appendChild(futureCategoryDiv);
                        currentFunctionContent.appendChild(currentCategoryDiv);
                    }
                }

                if (hasCategories) {
                    futureContainer.appendChild(futureFunctionDiv);
                    currentContainer.appendChild(currentFunctionDiv);

                    // Expandir por padrão
                    futureFunctionDiv.querySelector('.function-content').classList.add('expanded');
                    futureFunctionDiv.querySelector('.toggle-icon').classList.add('expanded');
                    currentFunctionDiv.querySelector('.function-content').classList.add('expanded');
                    currentFunctionDiv.querySelector('.toggle-icon').classList.add('expanded');
                }
            }

            // Atualizar informações da seleção
            safeUpdateElement('selectionInfo', `
                <h2>Governança - Cenário Futuro vs Atual</h2>
                <p><strong>Total de subcategorias selecionadas:</strong> ${totalSubcategories}</p>
                <p><strong>Função atual:</strong> Governança (GV)</p>
                <p><em>O Cenário Futuro mostra os dados existentes (somente leitura). O Cenário Atual foi automaticamente preenchido com os dados do Futuro e está pronto para edição.</em></p>
                <div class="info-message">
                    <strong>✅ Dados carregados automaticamente!</strong><br>
                    O Cenário Atual já foi preenchido com os dados do Cenário Futuro. Faça as edições necessárias e clique em "Salvar Alterações".
                </div>
            `);

            if (totalSubcategories === 0) {
                futureContainer.innerHTML = `
                <div class="empty-state">
                    <h3>Nenhuma subcategoria de Governança selecionada</h3>
                    <p>Avance para a próxima função ou volte para selecionar subcategorias.</p>
                </div>
            `;
                currentContainer.innerHTML = `
                <div class="empty-state">
                    <h3>Nenhuma subcategoria de Governança selecionada</h3>
                    <p>Avance para a próxima função ou volte para selecionar subcategorias.</p>
                </div>
            `;
            }
        }

        // Criar estrutura da função
        function criarEstruturaFuncao(functionName) {
            const functionDiv = document.createElement('div');
            functionDiv.className = 'function-section';

            const functionHeader = document.createElement('div');
            functionHeader.className = 'function-header';
            functionHeader.innerHTML = `
            <h2>${functionNames[functionName] || functionName}</h2>
            <span class="toggle-icon"></span>
        `;

            const functionContent = document.createElement('div');
            functionContent.className = 'function-content';

            functionHeader.addEventListener('click', function () {
                functionContent.classList.toggle('expanded');
                functionHeader.querySelector('.toggle-icon').classList.toggle('expanded');
            });

            functionDiv.appendChild(functionHeader);
            functionDiv.appendChild(functionContent);

            return functionDiv;
        }

        // Criar estrutura da categoria
        function criarEstruturaCategoria(categoryId) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category-section';

            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category-header';

            const categoriaNome = obterNomeCategoria(categoryId);
            categoryHeader.innerHTML = `
            <h3>${categoriaNome}</h3>
            <span class="toggle-icon"></span>
        `;

            const categoryContent = document.createElement('div');
            categoryContent.className = 'category-content';

            categoryHeader.addEventListener('click', function () {
                categoryContent.classList.toggle('expanded');
                categoryHeader.querySelector('.toggle-icon').classList.toggle('expanded');
            });

            categoryDiv.appendChild(categoryHeader);
            categoryDiv.appendChild(categoryContent);

            return categoryDiv;
        }

        // Criar formulário para cenário FUTURO (somente leitura) - VERSÃO CORRIGIDA
function criarFormularioFuturo(subcategoryId, formIndex) {
    const subcategoriaTexto = obterNomeSubcategoria(subcategoryId);
    const dadosFuturos = dadosFuturosCache[subcategoryId] || {};

    const subcategoryDiv = document.createElement('div');
    subcategoryDiv.className = 'subcategory-item';

    console.log(`Criando formulário futuro para ${subcategoryId}:`, dadosFuturos);

    // Usar os nomes já formatados do controller OU buscar nos catálogos
    const prioridadeTexto = dadosFuturos.prioridadeNome || 
                           (prioridadesData.find(p => p.id == dadosFuturos.prioridadeAlvo)?.nivel) || 
                           'Não definida';
    
    const nivelTexto = dadosFuturos.nivelNome || 
                      (niveisData.find(n => n.id == dadosFuturos.nivelAlvo)?.nivel) || 
                      'Não definido';

    subcategoryDiv.innerHTML = `
        <h4>${subcategoriaTexto}</h4>
        
        <!-- Informações de Debug -->
        <div style="background: #f8f9fa; padding: 8px; margin-bottom: 15px; border-radius: 4px; font-size: 12px;">
            <strong>Debug:</strong> 
            Prioridade ID: ${dadosFuturos.prioridadeAlvo || 'N/A'}, 
            Nível ID: ${dadosFuturos.nivelAlvo || 'N/A'}
        </div>
        
        <div class="form-group">
            <label>Prioridade Alvo:</label>
            <input type="text" class="form-control readonly-field" 
                   value="${prioridadeTexto}" readonly />
        </div>
        <div class="form-group">
            <label>Nível Alvo:</label>
            <input type="text" class="form-control readonly-field" 
                   value="${nivelTexto}" readonly />
        </div>
        <div class="form-group">
            <label>Políticas, Processos e Procedimentos Futuros:</label>
            <textarea class="form-control readonly-field" rows="4" readonly>${dadosFuturos.politicasAlvo || 'Não informado'}</textarea>
        </div>
        <div class="form-group">
            <label>Práticas internas futuras:</label>
            <textarea class="form-control readonly-field" rows="4" readonly>${dadosFuturos.praticasAlvo || 'Não informado'}</textarea>
        </div>
        <div class="form-group">
            <label>Funções e responsabilidades futuras:</label>
            <textarea class="form-control readonly-field" rows="4" readonly>${dadosFuturos.funcoesAlvo || 'Não informado'}</textarea>
        </div>
        <div class="form-group">
            <label>Referências informativas futuras:</label>
            <textarea class="form-control readonly-field" rows="4" readonly>${dadosFuturos.referenciasAlvo || 'Não informado'}</textarea>
        </div>
        <div class="form-group">
            <label>Artefatos e evidências futuras:</label>
            <textarea class="form-control readonly-field" rows="4" readonly>${dadosFuturos.artefatosAlvo || 'Não informado'}</textarea>
        </div>
        
        ${dadosFuturos.dataRegistro ? `
        <div class="form-group">
            <label>Última atualização:</label>
            <input type="text" class="form-control readonly-field" 
                   value="${new Date(dadosFuturos.dataRegistro).toLocaleDateString('pt-BR')}" readonly />
        </div>
        ` : ''}
    `;

    return subcategoryDiv;
}

        // Criar formulário para cenário ATUAL (editável)
        function criarFormularioAtual(subcategoryId, formIndex) {
            const subcategoriaTexto = obterNomeSubcategoria(subcategoryId);
            const dadosAtuais = dadosAtuaisCache[subcategoryId] || {};

            const subcategoryDiv = document.createElement('div');
            subcategoryDiv.className = 'subcategory-item';

            subcategoryDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h4>${subcategoriaTexto}</h4>
            <button class="remove-btn" onclick="removerSubcategoriaAtual('${subcategoryId}', this)">×</button>
        </div>
        
        <div class="form-group">
            <label for="current-prioridade-${formIndex}">Prioridade:</label>
            <select id="current-prioridade-${formIndex}" class="form-control">
                <option value="">Selecione a prioridade</option>
                ${prioridadesData.map(p =>
                `<option value="${p.id}" ${dadosAtuais.prioridade == p.id ? 'selected' : ''}>${p.nivel}</option>`
            ).join('')}
            </select>
        </div>
        
        <div class="form-group">
            <label for="current-nivel-${formIndex}">Nível:</label>
            <select id="current-nivel-${formIndex}" class="form-control">
                <option value="">Selecione o nível</option>
                ${niveisData.map(n =>
                `<option value="${n.id}" ${dadosAtuais.status == n.id ? 'selected' : ''}>${n.nivel}</option>`
            ).join('')}
            </select>
        </div>
        
        <div class="form-group">
            <label for="current-politicasPro-${formIndex}">Políticas, Processos e Procedimentos:</label>
            <textarea id="current-politicasPro-${formIndex}" class="form-control" 
                      rows="4" placeholder="Descreva as políticas, processos e procedimentos...">${dadosAtuais.politicasPro || ''}</textarea>
        </div>
        
        <div class="form-group">
            <label for="current-praticasInternas-${formIndex}">Práticas internas:</label>
            <textarea id="current-praticasInternas-${formIndex}" class="form-control" 
                      rows="4" placeholder="Descreva as práticas internas...">${dadosAtuais.praticasInternas || ''}</textarea>
        </div>
        
        <div class="form-group">
            <label for="current-funcoesResp-${formIndex}">Funções e responsabilidades:</label>
            <textarea id="current-funcoesResp-${formIndex}" class="form-control" 
                      rows="4" placeholder="Descreva as funções e responsabilidades...">${dadosAtuais.funcoesResp || ''}</textarea>
        </div>
        
        <div class="form-group">
            <label for="current-referenciasInfo-${formIndex}">Referências informativas:</label>
            <textarea id="current-referenciasInfo-${formIndex}" class="form-control" 
                      rows="4" placeholder="Liste as referências informativas...">${dadosAtuais.referenciasInfo || ''}</textarea>
        </div>
        
        <div class="form-group">
            <label for="current-artefatosEvi-${formIndex}">Artefatos e evidências:</label>
            <textarea id="current-artefatosEvi-${formIndex}" class="form-control" 
                      rows="4" placeholder="Descreva os artefatos e evidências...">${dadosAtuais.artefatosEvi || ''}</textarea>
        </div>
        
        <input type="hidden" id="current-subcategory-${formIndex}" value="${subcategoryId}">
    `;

            return subcategoryDiv;
        }

        // Funções de navegação
        function voltarParaAnterior() {
            const selections = JSON.parse(localStorage.getItem('nistSelections') || '{}');
            const indiceAtual = ordemFuncoes.indexOf(funcaoAtual);

            for (let i = indiceAtual - 1; i >= 0; i--) {
                const funcaoAnterior = ordemFuncoes[i];
                for (const funcId in selections) {
                    const functionName = getFunctionNameById(funcId);
                    if (functionName === funcaoAnterior) {
                        for (const category in selections[funcId]) {
                            if (selections[funcId][category].length > 0) {
                                window.location.href = `/Home/${funcaoAnterior.charAt(0).toUpperCase() + funcaoAnterior.slice(1)}`;
                                return;
                            }
                        }
                    }
                }
            }

            window.location.href = '/Home/PrecadastroAtual';
        }

        function avancarParaProxima() {
            const selections = JSON.parse(localStorage.getItem('nistSelections') || '{}');
            const indiceAtual = ordemFuncoes.indexOf(funcaoAtual);

            for (let i = indiceAtual + 1; i < ordemFuncoes.length; i++) {
                const proximaFuncao = ordemFuncoes[i];
                for (const funcId in selections) {
                    const functionName = getFunctionNameById(funcId);
                    if (functionName === proximaFuncao) {
                        for (const category in selections[funcId]) {
                            if (selections[funcId][category].length > 0) {
                                window.location.href = `/Home/${proximaFuncao.charAt(0).toUpperCase() + proximaFuncao.slice(1)}`;
                                return;
                            }
                        }
                    }
                }
            }

            window.location.href = '/Home';
        }

        function removerSubcategoriaAtual(subcategoryId, btnElement) {
            const confirmacao = confirm("Deseja remover esta subcategoria do cenário atual?");
            if (!confirmacao) return;

            const subcategoryItem = btnElement.closest('.subcategory-item');
            subcategoryItem.remove();
            // Recarregar a contagem
            const selectedSubcategories = JSON.parse(localStorage.getItem('nistSelections') || '{}');
            exibirCenarios(selectedSubcategories);
        }

        async function salvarAlteracoesAtual() {
            try {
                // Coletar dados dos formulários do CENÁRIO ATUAL
                const forms = document.querySelectorAll('#currentScenarioContainer .subcategory-item');
                const dadosParaSalvar = [];

                for (let i = 0; i < forms.length; i++) {
                    const subcategoryId = document.getElementById(`current-subcategory-${i}`)?.value;
                    if (!subcategoryId) continue;

                    dadosParaSalvar.push({
                        subcategoriaId: parseInt(subcategoryId),
                        prioridade: document.getElementById(`current-prioridade-${i}`)?.value || null,
                        status: document.getElementById(`current-nivel-${i}`)?.value || null,
                        politicasPro: document.getElementById(`current-politicasPro-${i}`)?.value || '',
                        praticasInternas: document.getElementById(`current-praticasInternas-${i}`)?.value || '',
                        funcoesResp: document.getElementById(`current-funcoesResp-${i}`)?.value || '',
                        referenciasInfo: document.getElementById(`current-referenciasInfo-${i}`)?.value || '',
                        artefatosEvi: document.getElementById(`current-artefatosEvi-${i}`)?.value || ''
                    });
                }

                if (dadosParaSalvar.length === 0) {
                    alert('Nenhum dado para salvar.');
                    return;
                }

                // Determinar a API correta
                const apiMap = {
                    'governanca': 'GovernancaAtual',
                    'identificar': 'IdentificarAtual',
                    'proteger': 'ProtegerAtual',
                    'detectar': 'DetectarAtual',
                    'responder': 'ResponderAtual',
                    'recuperar': 'RecuperarAtual'
                };

                const apiName = apiMap[funcaoAtual] || 'CenarioAtual';

                // Enviar para a API
                const response = await fetch(`/api/${apiName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosParaSalvar)
                });

                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);

                const resultado = await response.json();
                alert('Alterações no Cenário Atual salvas com sucesso!');

            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('Erro ao salvar: ' + error.message);
            }
        }
    </script>
</body>

</html>