<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIST CSF - Alterações - Governança</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 600;
            color: #2c3e50;
        }

        .selection-info {
            background: #e8f4fc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #3498db;
        }

        .scenario-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .scenario-section {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .scenario-header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .scenario-content {
            padding: 20px;
        }

        .current-scenario .scenario-header {
            background: #7f8c8d;
        }

        .future-scenario .scenario-header {
            background: #27ae60;
        }

        .function-section {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .function-header {
            background: #3498db;
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .function-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .function-content.expanded {
            max-height: 5000px;
        }

        .category-section {
            border-bottom: 1px solid #eee;
        }

        .category-header {
            background: #f8f9fa;
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .category-content.expanded {
            max-height: 5000px;
        }

        .subcategory-item {
            background: #ffffff;
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .subcategory-item:last-child {
            border-bottom: none;
        }

        .subcategory-item h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.1em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            resize: vertical;
        }

        .form-group textarea {
            min-height: 100px;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn-voltar {
            background: #95a5a6;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-voltar:hover {
            background: #7f8c8d;
        }

        .btn-salvar {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-salvar:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
        }

        .btn-avancar {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-avancar:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
        }

        .error-message {
            background: #ffecec;
            color: #e10;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e10;
            margin-bottom: 20px;
        }

        .success-message {
            background: #e8f5e9;
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
            margin-bottom: 20px;
        }

        .toggle-icon::after {
            content: "▼";
            font-size: 0.8em;
            transition: transform 0.3s;
        }

        .toggle-icon.expanded::after {
            transform: rotate(180deg);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .remove-btn {
            background: transparent;
            border: none;
            font-size: 1.2em;
            color: #e74c3c;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .remove-btn:hover {
            transform: scale(1.2);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .readonly-field {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .field-note {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>NIST CSF - Alterações - Governança</h1>

        <div class="selection-info" id="selectionInfo">
            <h2>Carregando seleção...</h2>
        </div>

        <div class="scenario-container">
            <!-- Cenário Atual -->
            <div class="scenario-section current-scenario">
                <div class="scenario-header">
                    CENÁRIO ATUAL (Dados do Banco - Somente Leitura)
                </div>
                <div class="scenario-content">
                    <div id="currentScenarioContainer">
                        <div class="loading">Carregando cenário atual...</div>
                    </div>
                </div>
            </div>

            <!-- Cenário Futuro -->
            <div class="scenario-section future-scenario">
                <div class="scenario-header">
                    CENÁRIO FUTURO (Editável)
                </div>
                <div class="scenario-content">
                    <div id="futureScenarioContainer">
                        <div class="loading">Carregando cenário futuro...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="navigation">
            <button class="btn-voltar" onclick="voltarParaSelecao()">← Voltar para Seleção</button>
            <button class="btn-salvar" onclick="salvarAlteracoes()">Salvar Alterações</button>
            <button class="btn-avancar" onclick="avancarParaProxima()">Avançar para Próxima Função</button>
        </div>
    </div>

    <script>
        // CONSTANTES E CONFIGURAÇÕES
        const ordemFuncoes = ["governanca", "identificar", "proteger", "detectar", "responder", "recuperar"];
        const funcaoAtual = "governanca";

        // Mapeamento baseado nos IDs do seu sistema
        const mapeamentoFuncoes = {
            '1': 'governanca',      // GV
            '2': 'identificar',     // ID  
            '3': 'proteger',        // PR
            '4': 'detectar',        // DE
            '5': 'responder',       // RS
            '6': 'recuperar'        // RC
        };

        const functionNames = {
            'governanca': 'Governança (GV)',
            'identificar': 'Identificar (ID)',
            'proteger': 'Proteger (PR)',
            'detectar': 'Detectar (DE)',
            'responder': 'Responder (RS)',
            'recuperar': 'Recuperar (RC)'
        };

        // Cache para dados
        let categoriasCache = {};
        let subcategoriasCache = {};
        let dadosAtuaisCache = {};
        let dadosFuturosCache = {};
        let prioridadesData = [];
        let niveisData = [];

        // FUNÇÃO PRINCIPAL DE CARREGAMENTO - COMPLETAMENTE REESCRITA
        document.addEventListener('DOMContentLoaded', async function () {
            console.log('=== INICIANDO CARREGAMENTO DA GOVERNANÇA ===');
            
            try {
                // 1. Carregar catálogos primeiro
                await carregarCatálogos();

                // 2. Carregar e processar seleções do localStorage
                const selecoes = await processarSelecoesLocalStorage();
                if (!selecoes) return;

                // 3. Exibir cenários
                await exibirCenarios(selecoes);

                console.log('=== CARREGAMENTO CONCLUÍDO ===');

            } catch (error) {
                console.error('Erro crítico no carregamento:', error);
                mostrarErroCritico(error);
            }
        });

        // FUNÇÃO CORRIGIDA: Carregar todos os catálogos
        async function carregarCatálogos() {
            console.log('Carregando catálogos...');
            
            // Carregar prioridades
            try {
                const prioridades = await fetchAPI('/api/Dados/prioridades');
                if (prioridades && Array.isArray(prioridades)) {
                    prioridadesData = prioridades;
                    console.log('Prioridades carregadas:', prioridadesData);
                } else {
                    // Dados mock para teste
                    prioridadesData = [
                        { id: 1, nivel: 'Baixa' },
                        { id: 2, nivel: 'Média' },
                        { id: 3, nivel: 'Alta' }
                    ];
                    console.log('Usando prioridades mock');
                }
            } catch (error) {
                console.error('Erro ao carregar prioridades:', error);
                prioridadesData = [
                    { id: 1, nivel: 'Baixa' },
                    { id: 2, nivel: 'Média' },
                    { id: 3, nivel: 'Alta' }
                ];
            }

            // Carregar níveis
            try {
                const niveis = await fetchAPI('/api/Dados/status');
                if (niveis && Array.isArray(niveis)) {
                    niveisData = niveis;
                    console.log('Níveis carregados:', niveisData);
                } else {
                    // Dados mock para teste
                    niveisData = [
                        { id: 1, nivel: 'Inicial' },
                        { id: 2, nivel: 'Em Desenvolvimento' },
                        { id: 3, nivel: 'Definido' },
                        { id: 4, nivel: 'Gerenciado' },
                        { id: 5, nivel: 'Otimizado' }
                    ];
                    console.log('Usando níveis mock');
                }
            } catch (error) {
                console.error('Erro ao carregar níveis:', error);
                niveisData = [
                    { id: 1, nivel: 'Inicial' },
                    { id: 2, nivel: 'Em Desenvolvimento' },
                    { id: 3, nivel: 'Definido' },
                    { id: 4, nivel: 'Gerenciado' },
                    { id: 5, nivel: 'Otimizado' }
                ];
            }
        }

        // FUNÇÃO CORRIGIDA: Processar seleções do localStorage
        async function processarSelecoesLocalStorage() {
            try {
                const storedSelections = localStorage.getItem('nistSelections');
                console.log('Dados brutos do localStorage:', storedSelections);
                
                if (!storedSelections) {
                    mostrarErro('Nenhuma seleção encontrada no localStorage');
                    return null;
                }

                const selections = JSON.parse(storedSelections);
                console.log('Seleções parseadas:', selections);

                // ANALISAR ESTRUTURA DOS DADOS
                console.log('Analisando estrutura dos dados...');
                
                // ESTRUTURA: {"1":{"1":[3]},"3":{"15":[]}}
                // Isso significa: Função 1 (Governança), Categoria 1, Subcategoria 3
                let selecoesGovernanca = [];
                
                for (const funcaoId in selections) {
                    const functionName = getFunctionNameById(funcaoId);
                    console.log(`Função ${funcaoId}: ${functionName}`);
                    
                    if (functionName === 'governanca') {
                        const categorias = selections[funcaoId];
                        for (const categoriaId in categorias) {
                            const subcategorias = categorias[categoriaId];
                            console.log(`Categoria ${categoriaId}, Subcategorias:`, subcategorias);
                            
                            if (subcategorias && subcategorias.length > 0) {
                                selecoesGovernanca.push({
                                    funcaoId: funcaoId,
                                    categoriaId: categoriaId,
                                    subcategorias: subcategorias
                                });
                            }
                        }
                    }
                }

                console.log('Seleções de governança encontradas:', selecoesGovernanca);

                if (selecoesGovernanca.length === 0) {
                    mostrarMensagemNaoSelecionada();
                    return null;
                }

                // Carregar informações detalhadas
                await carregarInformacoesDetalhadas(selecoesGovernanca);
                
                return selecoesGovernanca;

            } catch (error) {
                console.error('Erro ao processar localStorage:', error);
                mostrarErro('Erro ao processar seleções: ' + error.message);
                return null;
            }
        }

        // FUNÇÃO CORRIGIDA: Carregar informações detalhadas
        async function carregarInformacoesDetalhadas(selecoesGovernanca) {
            console.log('Carregando informações detalhadas...');
            
            for (const selecao of selecoesGovernanca) {
                const { funcaoId, categoriaId, subcategorias } = selecao;

                // Carregar categoria
                if (!categoriasCache[categoriaId]) {
                    try {
                        const categoria = await fetchAPI(`/api/Categorias/${categoriaId}`);
                        if (categoria) {
                            categoriasCache[categoriaId] = categoria;
                            console.log(`Categoria ${categoriaId} carregada:`, categoria);
                        } else {
                            // Fallback
                            categoriasCache[categoriaId] = {
                                id: categoriaId,
                                codigo: `CAT-${categoriaId}`,
                                nome: `Categoria ${categoriaId}`
                            };
                        }
                    } catch (error) {
                        console.error(`Erro ao carregar categoria ${categoriaId}:`, error);
                        categoriasCache[categoriaId] = {
                            id: categoriaId,
                            codigo: `CAT-${categoriaId}`,
                            nome: `Categoria ${categoriaId}`
                        };
                    }
                }

                // Carregar subcategorias
                for (const subcategoriaId of subcategorias) {
                    if (!subcategoriasCache[subcategoriaId]) {
                        try {
                            const subcategoria = await fetchAPI(`/api/Subcategorias/${subcategoriaId}`);
                            if (subcategoria) {
                                subcategoriasCache[subcategoriaId] = subcategoria;
                                console.log(`Subcategoria ${subcategoriaId} carregada:`, subcategoria);
                            } else {
                                // Fallback
                                subcategoriasCache[subcategoriaId] = {
                                    id: subcategoriaId,
                                    codigo: `SC-${subcategoriaId}`,
                                    descricao: `Subcategoria ${subcategoriaId}`,
                                    subcategoria: `Subcategoria ${subcategoriaId}`
                                };
                            }
                        } catch (error) {
                            console.error(`Erro ao carregar subcategoria ${subcategoriaId}:`, error);
                            subcategoriasCache[subcategoriaId] = {
                                id: subcategoriaId,
                                codigo: `SC-${subcategoriaId}`,
                                descricao: `Subcategoria ${subcategoriaId}`,
                                subcategoria: `Subcategoria ${subcategoriaId}`
                            };
                        }
                    }
                }
            }
        }

        // FUNÇÃO CORRIGIDA: Exibir cenários
        async function exibirCenarios(selecoesGovernanca) {
            const currentContainer = document.getElementById('currentScenarioContainer');
            const futureContainer = document.getElementById('futureScenarioContainer');
            
            currentContainer.innerHTML = '';
            futureContainer.innerHTML = '';

            let totalSubcategories = 0;

            // Criar estrutura para governança
            const currentFunctionDiv = criarEstruturaFuncao('governanca');
            const futureFunctionDiv = criarEstruturaFuncao('governanca');

            for (const selecao of selecoesGovernanca) {
                const { categoriaId, subcategorias } = selecao;

                const currentCategoryDiv = criarEstruturaCategoria(categoriaId);
                const futureCategoryDiv = criarEstruturaCategoria(categoriaId);

                for (const subcategoriaId of subcategorias) {
                    const globalIndex = totalSubcategories;
                    
                    // Carregar dados do banco para esta subcategoria
                    await carregarDadosSubcategoria(subcategoriaId);
                    
                    const currentSub = criarFormularioAtual(subcategoriaId, globalIndex);
                    const futureSub = criarFormularioFuturo(subcategoriaId, globalIndex);
                    
                    currentCategoryDiv.querySelector('.category-content').appendChild(currentSub);
                    futureCategoryDiv.querySelector('.category-content').appendChild(futureSub);
                    
                    totalSubcategories++;
                }

                currentFunctionDiv.querySelector('.function-content').appendChild(currentCategoryDiv);
                futureFunctionDiv.querySelector('.function-content').appendChild(futureCategoryDiv);
            }

            currentContainer.appendChild(currentFunctionDiv);
            futureContainer.appendChild(futureFunctionDiv);

            // Atualizar informações
            safeUpdateElement('selectionInfo', `
                <h2>Governança - Cenário Atual vs Futuro</h2>
                <p><strong>Total de subcategorias selecionadas:</strong> ${totalSubcategories}</p>
                <p><em>Cenário atual: dados existentes | Cenário futuro: dados a serem salvos</em></p>
            `);

            // Expandir tudo por padrão
            expandirTodosOsElementos();
        }

        // FUNÇÃO AUXILIAR: Carregar dados da subcategoria
        async function carregarDadosSubcategoria(subcategoriaId) {
            // Dados atuais
            if (!dadosAtuaisCache[subcategoriaId]) {
                try {
                    const dadosAtuais = await fetchAPI(`/api/CenarioAtual?subcategoriaId=${subcategoriaId}`);
                    if (dadosAtuais && Array.isArray(dadosAtuais) && dadosAtuais.length > 0) {
                        dadosAtuaisCache[subcategoriaId] = dadosAtuais[0];
                    }
                } catch (error) {
                    console.error(`Erro ao carregar dados atuais para ${subcategoriaId}:`, error);
                }
            }

            // Dados futuros
            if (!dadosFuturosCache[subcategoriaId]) {
                try {
                    const dadosFuturos = await fetchAPI(`/api/CenarioFuturo?subcategoriaId=${subcategoriaId}`);
                    if (dadosFuturos && Array.isArray(dadosFuturos) && dadosFuturos.length > 0) {
                        dadosFuturosCache[subcategoriaId] = dadosFuturos[0];
                    }
                } catch (error) {
                    console.error(`Erro ao carregar dados futuros para ${subcategoriaId}:`, error);
                }
            }
        }

        // FUNÇÃO AUXILIAR: Expandir todos os elementos
        function expandirTodosOsElementos() {
            const functionContents = document.querySelectorAll('.function-content');
            const categoryContents = document.querySelectorAll('.category-content');
            const toggleIcons = document.querySelectorAll('.toggle-icon');

            functionContents.forEach(content => content.classList.add('expanded'));
            categoryContents.forEach(content => content.classList.add('expanded'));
            toggleIcons.forEach(icon => icon.classList.add('expanded'));
        }

        // FUNÇÃO AUXILIAR: Fetch API
        async function fetchAPI(url) {
            try {
                console.log(`Fetching: ${url}`);
                const response = await fetch(url);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        console.warn(`Endpoint não encontrado: ${url}`);
                        return null;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`Erro na API ${url}:`, error);
                return null;
            }
        }

        // FUNÇÃO AUXILIAR: Obter nome da função pelo ID
        function getFunctionNameById(funcId) {
            return mapeamentoFuncoes[funcId] || funcId;
        }

        // FUNÇÃO AUXILIAR: Atualizar elemento de forma segura
        function safeUpdateElement(elementId, content) {
            const element = document.getElementById(elementId);
            if (element) element.innerHTML = content;
        }

        // FUNÇÃO AUXILIAR: Mostrar erro
        function mostrarErro(mensagem) {
            safeUpdateElement('selectionInfo', `
                <div class="error-message">
                    <h2>Erro</h2>
                    <p>${mensagem}</p>
                </div>
            `);
        }

        // FUNÇÃO AUXILIAR: Mostrar mensagem de não selecionada
        function mostrarMensagemNaoSelecionada() {
            safeUpdateElement('selectionInfo', `
                <div class="success-message">
                    <h2>Governança não selecionada</h2>
                    <p>Avance para a próxima função com seleções.</p>
                </div>
            `);
        }

        // FUNÇÃO AUXILIAR: Mostrar erro crítico
        function mostrarErroCritico(error) {
            safeUpdateElement('selectionInfo', `
                <div class="error-message">
                    <h2>Erro ao carregar a página</h2>
                    <p>${error.message}</p>
                </div>
            `);
        }

        // FUNÇÕES DE CRIAÇÃO DE ESTRUTURA (mantenha as originais)
        function criarEstruturaFuncao(functionName) {
            const functionDiv = document.createElement('div');
            functionDiv.className = 'function-section';

            const functionHeader = document.createElement('div');
            functionHeader.className = 'function-header';
            functionHeader.innerHTML = `
                <h2>${functionNames[functionName] || functionName}</h2>
                <span class="toggle-icon"></span>
            `;

            const functionContent = document.createElement('div');
            functionContent.className = 'function-content';

            functionHeader.addEventListener('click', function () {
                functionContent.classList.toggle('expanded');
                functionHeader.querySelector('.toggle-icon').classList.toggle('expanded');
            });

            functionDiv.appendChild(functionHeader);
            functionDiv.appendChild(functionContent);

            return functionDiv;
        }

        function criarEstruturaCategoria(categoryId) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category-section';

            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category-header';

            const categoria = categoriasCache[categoryId] || { codigo: `CAT-${categoryId}`, nome: `Categoria ${categoryId}` };
            const categoriaNome = `${categoria.codigo} - ${categoria.nome}`;

            categoryHeader.innerHTML = `
                <h3>${categoriaNome}</h3>
                <span class="toggle-icon"></span>
            `;

            const categoryContent = document.createElement('div');
            categoryContent.className = 'category-content';

            categoryHeader.addEventListener('click', function () {
                categoryContent.classList.toggle('expanded');
                categoryHeader.querySelector('.toggle-icon').classList.toggle('expanded');
            });

            categoryDiv.appendChild(categoryHeader);
            categoryDiv.appendChild(categoryContent);

            return categoryDiv;
        }

        function criarFormularioAtual(subcategoryId, formIndex) {
            const subcategoria = subcategoriasCache[subcategoryId] || { 
                codigo: `SC-${subcategoryId}`, 
                descricao: `Subcategoria ${subcategoryId}` 
            };
            const dados = dadosAtuaisCache[subcategoryId] || {};

            const subcategoryDiv = document.createElement('div');
            subcategoryDiv.className = 'subcategory-item';

            const prioridade = prioridadesData.find(p => p.id == dados.prioridade) || {};
            const nivel = niveisData.find(n => n.id == dados.status) || {};

            subcategoryDiv.innerHTML = `
                <h4>${subcategoria.codigo} - ${subcategoria.descricao}</h4>
                <div class="form-group">
                    <label>Prioridade:</label>
                    <input type="text" class="form-control readonly-field" 
                           value="${prioridade.nivel || 'Não definida'}" readonly />
                </div>
                <div class="form-group">
                    <label>Nível:</label>
                    <input type="text" class="form-control readonly-field" 
                           value="${nivel.nivel || 'Não definido'}" readonly />
                </div>
                <div class="form-group">
                    <label>Políticas, Processos e Procedimentos Atuais:</label>
                    <textarea class="form-control readonly-field" rows="4" readonly>${dados.politicasPro || 'Não informado'}</textarea>
                </div>
                <div class="form-group">
                    <label>Práticas internas:</label>
                    <textarea class="form-control readonly-field" rows="4" readonly>${dados.praticasInternas || 'Não informado'}</textarea>
                </div>
                <div class="form-group">
                    <label>Funções e responsabilidades:</label>
                    <textarea class="form-control readonly-field" rows="4" readonly>${dados.funcoesResp || 'Não informado'}</textarea>
                </div>
                <div class="form-group">
                    <label>Referências informativas:</label>
                    <textarea class="form-control readonly-field" rows="4" readonly>${dados.referenciasInfo || 'Não informado'}</textarea>
                </div>
                <div class="form-group">
                    <label>Artefatos e evidências:</label>
                    <textarea class="form-control readonly-field" rows="4" readonly>${dados.artefatosEvi || 'Não informado'}</textarea>
                </div>
            `;

            return subcategoryDiv;
        }

        function criarFormularioFuturo(subcategoryId, formIndex) {
            const subcategoria = subcategoriasCache[subcategoryId] || { 
                codigo: `SC-${subcategoryId}`, 
                descricao: `Subcategoria ${subcategoryId}` 
            };
            const dados = dadosFuturosCache[subcategoryId] || {};

            const subcategoryDiv = document.createElement('div');
            subcategoryDiv.className = 'subcategory-item';

            subcategoryDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4>${subcategoria.codigo} - ${subcategoria.descricao}</h4>
                    <button class="remove-btn" onclick="removerSubcategoriaFutura('${subcategoryId}', this)">×</button>
                </div>
                
                <div class="form-group">
                    <label for="future-prioridade-${formIndex}">Prioridade:</label>
                    <select id="future-prioridade-${formIndex}" class="form-control">
                        <option value="">Selecione a prioridade</option>
                        ${prioridadesData.map(p => 
                            `<option value="${p.id}" ${dados.prioridadeAlvo == p.id ? 'selected' : ''}>${p.nivel}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="future-nivel-${formIndex}">Nível:</label>
                    <select id="future-nivel-${formIndex}" class="form-control">
                        <option value="">Selecione o nível</option>
                        ${niveisData.map(n => 
                            `<option value="${n.id}" ${dados.nivelAlvo == n.id ? 'selected' : ''}>${n.nivel}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="future-politicasPro-${formIndex}">Políticas, Processos e Procedimentos:</label>
                    <textarea id="future-politicasPro-${formIndex}" class="form-control" rows="4">${dados.politicasAlvo || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="future-praticasInternas-${formIndex}">Práticas internas:</label>
                    <textarea id="future-praticasInternas-${formIndex}" class="form-control" rows="4">${dados.praticasAlvo || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="future-funcoesResp-${formIndex}">Funções e responsabilidades:</label>
                    <textarea id="future-funcoesResp-${formIndex}" class="form-control" rows="4">${dados.funcoesAlvo || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="future-referenciasInfo-${formIndex}">Referências informativas:</label>
                    <textarea id="future-referenciasInfo-${formIndex}" class="form-control" rows="4">${dados.referenciasAlvo || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="future-artefatosEvi-${formIndex}">Artefatos e evidências:</label>
                    <textarea id="future-artefatosEvi-${formIndex}" class="form-control" rows="4">${dados.artefatosAlvo || ''}</textarea>
                </div>
                
                <input type="hidden" id="future-subcategory-${formIndex}" value="${subcategoryId}">
            `;

            return subcategoryDiv;
        }

        // FUNÇÕES DE NAVEGAÇÃO
        function voltarParaSelecao() {
            window.location.href = '/Home/Precadastro';
        }

        function avancarParaProxima() {
            // Lógica para encontrar próxima função com seleções
            window.location.href = '/Home/Identificar'; // Ajuste conforme necessário
        }

        function removerSubcategoriaFutura(subcategoryId, btnElement) {
            if (confirm("Deseja remover esta subcategoria do cenário futuro?")) {
                btnElement.closest('.subcategory-item').remove();
            }
        }

        function salvarAlteracoes() {
            alert('Funcionalidade de salvar será implementada!');
            // Implemente a lógica de salvamento aqui
        }
    </script>
</body>

</html>