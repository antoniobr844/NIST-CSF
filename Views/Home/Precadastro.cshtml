<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIST CSF - Seleção de Subcategorias</title>

    <!-- CSS Compartilhado -->
    <link rel="stylesheet" href="/css/base/variables.css">
    <link rel="stylesheet" href="/css/base/reset.css">
    <link rel="stylesheet" href="/css/components/breadcrumb.css">
    <link rel="stylesheet" href="/css/components/forms.css">
    <link rel="stylesheet" href="/css/components/buttons.css">
    <link rel="stylesheet" href="/css/pages/precadastro.css">
</head>

<body>
    <div class="container">
        <h1>NIST CSF - Seleção de Subcategorias</h1>

        <div class="breadcrumb">
            <div class="active">Função</div>
            <div>Categoria</div>
            <div>Subcategorias</div>
        </div>

        <div class="combo-container">
            <label for="opcoesPrincipais">Selecione uma função:</label>
            <select id="opcoesPrincipais" disabled>
                <option value="">Carregando funções...</option>
            </select>
        </div>

        <div id="categoriasContainer" class="hidden">
            <div class="combo-container">
                <label for="categorias">Selecione uma categoria:</label>
                <select id="categorias" disabled>
                    <option value="">Selecione uma categoria</option>
                </select>
            </div>
        </div>

        <div id="subcategoriasContainer" class="hidden">
            <div class="global-selected-count" id="globalSelectedCount">
                Total de 0 subcategorias selecionadas em todas as categorias
            </div>

            <div class="selected-count" id="selectedCount">
                Nenhuma subcategoria selecionada nesta categoria
            </div>

            <div id="subcategoriasList" class="subcategorias-container">
                <!-- As subcategorias serão inseridas aqui via JavaScript -->
            </div>

            <div class="button-group">
                <button class="btn btn-danger" id="btnExcluir">
                    Excluir seleções
                </button>

                <button class="btn btn-warning" id="btnDesmarcarTodas">
                    Desmarcar subcategorias
                </button>

                <button class="btn btn-success" id="btnAvancar" disabled>
                    Avançar para Alterações
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Modularizado -->
    <script type="module">
        import { NistDataLoader } from '/js/modules/nistDataLoader.js';
        import { SelectionManager } from '/js/modules/selectionManager.js';
        import { BreadcrumbManager } from '/js/modules/breadcrumbManager.js';

        class PrecadastroPage {
            constructor() {
                this.dataLoader = new NistDataLoader();
                this.selectionManager = new SelectionManager();
                this.breadcrumb = new BreadcrumbManager();

                this.currentFunction = "";
                this.currentCategory = "";

                // Mapeamento de funções
                this.mapeamentoFuncoes = {
                    '1': 'Governanca',
                    '2': 'Identificar', 
                    '3': 'Proteger',
                    '4': 'Detectar',
                    '5': 'Responder',
                    '6': 'Recuperar'
                };

                this.init();
            }

            async init() {
                await this.carregarFuncoes();
                this.configurarEventos();
                this.atualizarContadorGlobal();
            }

            async carregarFuncoes() {
                try {
                    const funcoes = await this.dataLoader.carregarFuncoes();
                    this.preencherFuncoes(funcoes);
                } catch (error) {
                    this.mostrarErro('opcoesPrincipais', 'Erro ao carregar funções');
                }
            }

            preencherFuncoes(funcoes) {
                const select = document.getElementById('opcoesPrincipais');
                select.innerHTML = '<option value="">Selecione uma função</option>';

                funcoes.forEach(funcao => {
                    const option = document.createElement('option');
                    option.value = funcao.id || funcao.ID;
                    option.textContent = `${funcao.codigo || funcao.CODIGO || ''} - ${funcao.nome || funcao.NOME}`;
                    select.appendChild(option);
                });

                select.disabled = false;
                this.breadcrumb.update(1);
            }

            configurarEventos() {
                // Eventos dos selects
                document.getElementById('opcoesPrincipais').addEventListener('change',
                    (e) => this.onFuncaoSelecionada(e.target.value));

                document.getElementById('categorias').addEventListener('change',
                    (e) => this.onCategoriaSelecionada(e.target.value));

                // Eventos dos botões
                document.getElementById('btnExcluir').addEventListener('click',
                    () => this.excluirTodasSelecoes());

                document.getElementById('btnDesmarcarTodas').addEventListener('click',
                    () => this.desmarcarSubcategoriasAtuais());

                document.getElementById('btnAvancar').addEventListener('click',
                    () => this.avancarParaAlteracoes());
            }

            async onFuncaoSelecionada(funcaoId) {
                this.currentFunction = funcaoId;

                if (!funcaoId) {
                    this.ocultarContainer('categoriasContainer');
                    this.ocultarContainer('subcategoriasContainer');
                    this.breadcrumb.update(1);
                    return;
                }

                try {
                    const categorias = await this.dataLoader.carregarCategorias(funcaoId);
                    this.preencherCategorias(categorias);
                } catch (error) {
                    this.mostrarErro('categorias', 'Erro ao carregar categorias');
                }
            }

            preencherCategorias(categorias) {
                const select = document.getElementById('categorias');
                select.innerHTML = '<option value="">Selecione uma categoria</option>';

                categorias.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria.id || categoria.ID;
                    option.textContent = `${categoria.codigo || categoria.CODIGO || ''} - ${categoria.nome || categoria.NOME}`;
                    select.appendChild(option);
                });

                select.disabled = false;
                this.mostrarContainer('categoriasContainer');
                this.breadcrumb.update(2);
            }

            async onCategoriaSelecionada(categoriaId) {
                this.currentCategory = categoriaId;

                if (!categoriaId) {
                    this.ocultarContainer('subcategoriasContainer');
                    this.breadcrumb.update(2);
                    return;
                }

                try {
                    const subcategorias = await this.dataLoader.carregarSubcategorias(categoriaId);
                    this.exibirSubcategorias(subcategorias);
                } catch (error) {
                    this.mostrarErroSubcategorias('Erro ao carregar subcategorias');
                }
            }

            exibirSubcategorias(subcategorias) {
                const container = document.getElementById('subcategoriasList');
                container.innerHTML = '';

                if (subcategorias.length === 0) {
                    container.innerHTML = '<div class="no-data">Nenhuma subcategoria encontrada para esta categoria.</div>';
                    return;
                }

                // Criar tópico para as subcategorias
                const topicDiv = document.createElement('div');
                topicDiv.className = 'subcategoria-topic';

                const topicTitle = document.createElement('h3');
                const categoriaSelect = document.getElementById('categorias');
                const categoriaNome = categoriaSelect.options[categoriaSelect.selectedIndex].textContent;
                topicTitle.textContent = categoriaNome;
                topicDiv.appendChild(topicTitle);

                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'options';

                // Preencher as subcategorias como checkboxes
                subcategorias.forEach(subcategoria => {
                    const subcategoriaId = subcategoria.id || subcategoria.ID;

                    const label = this.criarCheckboxSubcategoria(
                        subcategoria,
                        subcategoriaId
                    );
                    optionsDiv.appendChild(label);
                });

                topicDiv.appendChild(optionsDiv);
                container.appendChild(topicDiv);

                this.mostrarContainer('subcategoriasContainer');
                this.breadcrumb.update(3);
                this.atualizarContadorLocal();
            }

            criarCheckboxSubcategoria(subcategoria, subcategoriaId) {
                const label = document.createElement('label');
                label.className = 'option-label';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'option-checkbox';
                checkbox.value = subcategoriaId;

                // Verificar se já está selecionada
                const isSelected = this.selectionManager.isSubcategorySelected(
                    this.currentFunction,
                    this.currentCategory,
                    subcategoriaId
                );

                if (isSelected) {
                    checkbox.checked = true;
                    label.classList.add('selected');
                }

                // Criar container para informações
                const infoDiv = document.createElement('div');
                infoDiv.className = 'subcategoria-info';

                // Buscar códigos da função e categoria atualmente selecionadas
                const funcaoSelect = document.getElementById('opcoesPrincipais');
                const categoriaSelect = document.getElementById('categorias');

                const funcaoCod = funcaoSelect.options[funcaoSelect.selectedIndex]?.textContent.split(' - ')[0] || '';
                const categoriaCod = categoriaSelect.options[categoriaSelect.selectedIndex]?.textContent.split(' - ')[0] || '';
                const subcatCod = subcategoria.codigo || subcategoria.CODIGO || subcategoria.subcategoria ||subcategoria.SUBCATEGORIA ;

                // Montar o texto completo: função.categoria - subcategoria
                const codigoSpan = document.createElement('span');
                codigoSpan.className = 'subcategoria-codigo';
                codigoSpan.textContent = `${funcaoCod}.${categoriaCod} - ${subcatCod}`;

                const descricaoSpan = document.createElement('span');
                descricaoSpan.className = 'subcategoria-descricao';
                descricaoSpan.textContent = subcategoria.descricao || subcategoria.DESCRICAO || '';

                infoDiv.appendChild(codigoSpan);
                infoDiv.appendChild(descricaoSpan);

                label.appendChild(checkbox);
                label.appendChild(infoDiv);

                // Evento de change
                checkbox.addEventListener('change', () => {
                    this.onSubcategoriaToggle(checkbox, subcategoriaId);
                });

                return label;
            }

            onSubcategoriaToggle(checkbox, subcategoriaId) {
                const label = checkbox.closest('.option-label');
                const wasAdded = this.selectionManager.toggleSubcategory(
                    this.currentFunction,
                    this.currentCategory,
                    subcategoriaId
                );

                if (wasAdded) {
                    label.classList.add('selected');
                } else {
                    label.classList.remove('selected');
                }

                this.selectionManager.saveSelections();
                this.atualizarContadorLocal();
                this.atualizarContadorGlobal();
                this.atualizarEstadoBotaoAvancar();
            }

            desmarcarSubcategoriasAtuais() {
                const checkboxes = document.querySelectorAll('#subcategoriasList .option-checkbox:checked');

                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    checkbox.closest('.option-label').classList.remove('selected');

                    // Atualizar no manager
                    this.selectionManager.toggleSubcategory(
                        this.currentFunction,
                        this.currentCategory,
                        checkbox.value
                    );
                });

                this.selectionManager.saveSelections();
                this.atualizarContadorLocal();
                this.atualizarContadorGlobal();
                this.atualizarEstadoBotaoAvancar();
            }

            excluirTodasSelecoes() {
                if (confirm('Tem certeza que deseja excluir todas as seleções?')) {
                    // Resetar selects
                    document.getElementById('opcoesPrincipais').selectedIndex = 0;
                    document.getElementById('categorias').selectedIndex = 0;

                    // Esconder containers
                    this.ocultarContainer('categoriasContainer');
                    this.ocultarContainer('subcategoriasContainer');

                    // Limpar seleções
                    this.selectionManager.clearAll();

                    // Atualizar contadores
                    this.atualizarContadorLocal();
                    this.atualizarContadorGlobal();
                    this.atualizarEstadoBotaoAvancar();

                    // Atualizar breadcrumb
                    this.breadcrumb.update(1);

                    alert("Todas as seleções foram resetadas!");
                }
            }

            // FUNÇÃO CORRIGIDA: Avançar para alterações
            avancarParaAlteracoes() {
                const totalSelecoes = this.selectionManager.getTotalSelectedCount();
                console.log('Total de seleções:', totalSelecoes);

                if (totalSelecoes === 0) {
                    alert('Selecione pelo menos uma subcategoria para avançar.');
                    return;
                }

                // Encontrar a primeira função que tem seleções
                const primeiraFuncaoComSelecoes = this.encontrarPrimeiraFuncaoComSelecoes();
                
                if (!primeiraFuncaoComSelecoes) {
                    alert('Erro: Não foi possível determinar a primeira função com seleções.');
                    return;
                }

                console.log('Primeira função com seleções:', primeiraFuncaoComSelecoes);

                // Redirecionar para a página da primeira função
                const paginaDestino = `/Home/${primeiraFuncaoComSelecoes}`;
                console.log('Redirecionando para:', paginaDestino);
                
                // Salvar seleções antes de redirecionar
                this.selectionManager.saveSelections();
                
                window.location.href = paginaDestino;
            }

            // FUNÇÃO CORRIGIDA: Encontrar a primeira função com seleções
            encontrarPrimeiraFuncaoComSelecoes() {
                const selecoes = this.selectionManager.selectedSubcategories;
                console.log('Estrutura de seleções:', selecoes);

                // Ordem das funções conforme definido no NIST CSF
                const ordemFuncoes = ['Governanca', 'Identificar', 'Proteger', 'Detectar', 'Responder', 'Recuperar'];
                
                // Para cada função na ordem, verificar se tem seleções
                for (const funcaoNome of ordemFuncoes) {
                    // Encontrar o ID da função pelo nome
                    const funcaoId = Object.keys(this.mapeamentoFuncoes).find(
                        key => this.mapeamentoFuncoes[key] === funcaoNome
                    );

                    console.log(`Verificando função: ${funcaoNome} (ID: ${funcaoId})`);

                    if (funcaoId && selecoes[funcaoId]) {
                        // Verificar se esta função tem alguma categoria com subcategorias selecionadas
                        const categorias = selecoes[funcaoId];
                        for (const categoriaId in categorias) {
                            if (categorias[categoriaId].length > 0) {
                                console.log(`✓ Função ${funcaoNome} tem ${categorias[categoriaId].length} seleções na categoria ${categoriaId}`);
                                return funcaoNome;
                            }
                        }
                    }
                }

                // Se não encontrou nenhuma função com seleções, tenta uma abordagem alternativa
                console.log('Tentando abordagem alternativa...');
                
                // Procura por qualquer função que tenha seleções, independente da ordem
                for (const funcaoId in selecoes) {
                    const categorias = selecoes[funcaoId];
                    for (const categoriaId in categorias) {
                        if (categorias[categoriaId].length > 0) {
                            const funcaoNome = this.mapeamentoFuncoes[funcaoId];
                            if (funcaoNome) {
                                console.log(`✓ Encontrada função ${funcaoNome} com seleções (abordagem alternativa)`);
                                return funcaoNome;
                            }
                        }
                    }
                }

                console.log('✗ Nenhuma função com seleções encontrada');
                return null;
            }

            atualizarContadorLocal() {
                const selectedCount = document.getElementById('selectedCount');
                const count = this.selectionManager.getSelectedCountByCategory(
                    this.currentFunction,
                    this.currentCategory
                );

                selectedCount.textContent =
                    count === 0 ? 'Nenhuma subcategoria selecionada nesta categoria' :
                        `${count} subcategoria${count !== 1 ? 's' : ''} selecionada${count !== 1 ? 's' : ''} nesta categoria`;
            }

            atualizarContadorGlobal() {
                const globalSelectedCount = document.getElementById('globalSelectedCount');
                const total = this.selectionManager.getTotalSelectedCount();

                globalSelectedCount.textContent =
                    `Total de ${total} subcategoria${total !== 1 ? 's' : ''} selecionada${total !== 1 ? 's' : ''} em todas as categorias`;
            }

            atualizarEstadoBotaoAvancar() {
                const btnAvancar = document.getElementById('btnAvancar');
                const total = this.selectionManager.getTotalSelectedCount();
                btnAvancar.disabled = total === 0;
                
                // Atualizar o texto do botão para mostrar quantas seleções foram feitas
                if (total > 0) {
                    btnAvancar.textContent = `Avançar para Alterações (${total} selecionada${total !== 1 ? 's' : ''})`;
                } else {
                    btnAvancar.textContent = 'Avançar para Alterações';
                }
            }

            mostrarContainer(containerId) {
                const container = document.getElementById(containerId);
                container.classList.remove('hidden');
                container.classList.add('visible');
            }

            ocultarContainer(containerId) {
                const container = document.getElementById(containerId);
                container.classList.add('hidden');
                container.classList.remove('visible');
            }

            mostrarErro(elementId, mensagem) {
                const element = document.getElementById(elementId);
                element.innerHTML = `<option value="">${mensagem}</option>`;
                element.disabled = false;
            }

            mostrarErroSubcategorias(mensagem) {
                const container = document.getElementById('subcategoriasList');
                container.innerHTML = `<div class="error">${mensagem}</div>`;
            }
        }

        // Inicializar a página
        document.addEventListener('DOMContentLoaded', () => {
            new PrecadastroPage();
        });
    </script>
</body>

</html>