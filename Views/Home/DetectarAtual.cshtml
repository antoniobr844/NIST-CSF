<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIST CSF - Altera√ß√µes - Detectar</title>
    <link rel="stylesheet" href="/css/pages/alteracoes.css">
</head>

<body>
    <div class="container">
        <h1>NIST CSF - Altera√ß√µes - Detectar</h1>

        <div class="selection-info" id="selectionInfo">
            <h2>Carregando sele√ß√£o...</h2>
        </div>

        <div class="scenario-container">
            <!-- Cen√°rio Futuro (somente leitura) -->
            <div class="scenario-section future-scenario">
                <div class="scenario-header">
                    CEN√ÅRIO FUTURO (Dados do Banco - Somente Leitura)
                </div>
                <div class="scenario-content">
                    <div id="futureScenarioContainer">
                        <div class="loading">Carregando cen√°rio futuro...</div>
                    </div>
                </div>
            </div>

            <!-- Cen√°rio Atual (edit√°vel) -->
            <div class="scenario-section current-scenario">
                <div class="scenario-header">
                    CEN√ÅRIO ATUAL (Edit√°vel)
                </div>
                <div class="scenario-content">
                    <div id="currentScenarioContainer">
                        <div class="loading">Carregando cen√°rio atual...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="navigation">
            <button class="btn-voltar" onclick="app.voltarParaAnterior()">‚Üê Voltar para Sele√ß√£o</button>
            <button class="btn-salvar" onclick="app.salvarAlteracoes()">Salvar Altera√ß√µes</button>
            <button class="btn-avancar" onclick="app.avancarParaProxima()">Avan√ßar para Pr√≥xima Fun√ß√£o</button>
        </div>
    </div>

    <!-- Carrega o js externo -->
    <script src="/js/core/nist-core.js"></script>

    <script>
        // Vari√°vel global para acesso
        let app;

        document.addEventListener('DOMContentLoaded', async function () {
            try {
                console.log('=== INICIANDO CARREGAMENTO ===');

                // 1. Cria a inst√¢ncia do NISTCore
                app = new NISTCore({
                    funcaoAtual: 'detectar',
                    modo: 'atual'
                });

                // 2. Torna global para os bot√µes
                window.app = app;

                // 3. Carregar sele√ß√µes primeiro
                const selecoesCarregadas = await app.carregarSelecoes();
                if (!selecoesCarregadas) {
                    console.log('Fun√ß√£o n√£o selecionada, parando carregamento');
                    return;
                }

                // 4. Carregar cat√°logos
                await app.carregarPrioridades();
                await app.carregarNiveis();

                // 5. Carregar dados detalhados e cen√°rios
                await app.carregarInformacoesDetalhadas();
                await app.carregarDadosCenarios();

                // 6. Exibir os dados na p√°gina
                await app.exibirCenarios();

                console.log('=== CARREGAMENTO CONCLU√çDO ===');
                console.log('Cache final:', app.cache);

            } catch (error) {
                console.error('Erro cr√≠tico:', error);
                if (app) {
                    app.safeUpdateElement('selectionInfo', `
                <div class="error-message">
                    <h2>Erro ao carregar a p√°gina</h2>
                    <p>${error.message}</p>
                </div>
            `);
                }
            }
        });
    </script>
    <script>
        // DEBUG COMPLETO DOS FORMUL√ÅRIOS
        function debugCompletoFormularios() {
            console.log('=== üêõ DEBUG COMPLETO DOS FORMUL√ÅRIOS ===');

            // 1. Verificar containers
            const currentContainer = document.getElementById('currentScenarioContainer');
            const futureContainer = document.getElementById('futureScenarioContainer');
            console.log('üì¶ Containers:', {
                current: currentContainer ? `Encontrado (${currentContainer.children.length} filhos)` : 'N√ÉO ENCONTRADO',
                future: futureContainer ? `Encontrado (${futureContainer.children.length} filhos)` : 'N√ÉO ENCONTRADO'
            });

            // 2. Verificar todos os formul√°rios
            const forms = document.querySelectorAll('.subcategory-item');
            console.log('üìù Total de formul√°rios (.subcategory-item):', forms.length);

            forms.forEach((form, index) => {
                console.log(`--- Formul√°rio ${index} ---`);

                // Verificar se est√° no container correto
                const container = form.closest('#currentScenarioContainer') ? 'CURRENT' :
                    form.closest('#futureScenarioContainer') ? 'FUTURE' : 'OUTRO';
                console.log(`   Container: ${container}`);

                // Verificar campos hidden
                const hiddenInputs = form.querySelectorAll('input[type="hidden"]');
                console.log(`   Campos hidden: ${hiddenInputs.length}`);

                hiddenInputs.forEach((hidden, hIndex) => {
                    console.log(`     Hidden ${hIndex}: ID="${hidden.id}", Value="${hidden.value}"`);
                });

                // Verificar outros campos
                const selects = form.querySelectorAll('select');
                const textareas = form.querySelectorAll('textarea');
                console.log(`   Selects: ${selects.length}, Textareas: ${textareas.length}`);
            });

            // 3. Verificar IDs espec√≠ficos dos campos hidden
            console.log('--- üîç BUSCA POR IDs ESPEC√çFICOS ---');
            for (let i = 0; i < 10; i++) {
                const currentHidden = document.getElementById(`current-subcategory-${i}`);
                const futureHidden = document.getElementById(`future-subcategory-${i}`);

                if (currentHidden || futureHidden) {
                    console.log(`   √çndice ${i}:`, {
                        current: currentHidden ? `ID="${currentHidden.id}", Value="${currentHidden.value}"` : 'N√ÉO EXISTE',
                        future: futureHidden ? `ID="${futureHidden.id}", Value="${futureHidden.value}"` : 'N√ÉO EXISTE'
                    });
                }
            }
        }

        // Executar debug ap√≥s a p√°gina carregar
        setTimeout(debugCompletoFormularios, 3000);
    </script>
</body>

</html>