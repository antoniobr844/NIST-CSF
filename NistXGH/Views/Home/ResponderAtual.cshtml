@{
    ViewData["Title"] = "NIST CSF - Alterações - Responder";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="/css/pages/alteracoes.css" asp-append-version="true" />
}
<div class="container">
    <h1>NIST CSF - Alterações - Responder</h1>

    <div class="selection-info" id="selectionInfo">
        <h2>Carregando seleção...</h2>
    </div>

    <div class="scenario-container">
        <!-- Cenário Futuro (AGORA somente leitura) -->
        <div class="scenario-section future-scenario">
            <div class="scenario-header">
                CENÁRIO FUTURO (Dados do Banco - Somente Leitura)
            </div>
            <div class="scenario-content">
                <div id="futureScenarioContainer">
                    <div class="loading">Carregando cenário futuro...</div>
                </div>
            </div>
        </div>

        <!-- Cenário Atual (AGORA editável) -->
        <div class="scenario-section current-scenario">
            <div class="scenario-header">
                CENÁRIO ATUAL (Editável)
            </div>
            <div class="scenario-content">
                <div id="currentScenarioContainer">
                    <div class="loading">Carregando cenário atual...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="navigation">
        <button class="btn-voltar" onclick="app.voltarParaAnterior()">← Voltar para Seleção</button>
        <button class="btn-salvar" onclick="app.salvarAlteracoes()">Salvar Alterações</button>
        <button class="btn-avancar" onclick="app.avancarParaProxima()">Avançar para Próxima Função</button>
    </div>
</div>

<!-- Carrega o js externo -->
<script src="/js/core/nist-core.js"></script>

<script>
    // Variável global para acesso
    let app;

    document.addEventListener('DOMContentLoaded', async function () {
        try {
            console.log('=== INICIANDO CARREGAMENTO ===');

            // 1. Cria a instância do NISTCore
            app = new NISTCore({
                funcaoAtual: 'responder',
                modo: 'atual'
            });

            // 2. Torna global para os botões
            window.app = app;

            // 3. Carregar seleções primeiro
            const selecoesCarregadas = await app.carregarSelecoes();
            if (!selecoesCarregadas) {
                console.log('Função não selecionada, parando carregamento');
                return;
            }

            // 4. Carregar catálogos
            await app.carregarPrioridades();
            await app.carregarNiveis();

            // 5. Carregar dados detalhados e cenários
            await app.carregarInformacoesDetalhadas();
            await app.carregarDadosCenarios();

            // 6. Exibir os dados na página
            await app.exibirCenarios();

            console.log('=== CARREGAMENTO CONCLUÍDO ===');
            console.log('Cache final:', app.cache);

        } catch (error) {
            console.error('Erro crítico:', error);
            if (app) {
                app.safeUpdateElement('selectionInfo', `
                <div class="error-message">
                    <h2>Erro ao carregar a página</h2>
                    <p>${error.message}</p>
                </div>
            `);
            }
        }
    });
</script>